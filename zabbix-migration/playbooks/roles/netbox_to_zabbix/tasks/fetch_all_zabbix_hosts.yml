---
- name: Zabbix login to obtain auth token
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    validate_certs: "{{ zabbix_validate_certs | default(false) }}"
    body:
      jsonrpc: "2.0"
      method: "user.login"
      params:
        username: "{{ zabbix_user }}"
        password: "{{ zabbix_password }}"
      id: 0
  register: zbx_login_resp
  run_once: true
  delegate_to: localhost

- name: Set zabbix_auth from login
  set_fact:
    zabbix_auth: "{{ zbx_login_resp.json.result }}"
  run_once: true
  delegate_to: localhost
  when: zbx_login_resp.json.result is defined

- name: Fetch all hosts from Zabbix
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    validate_certs: "{{ zabbix_validate_certs | default(false) }}"
    body:
      jsonrpc: "2.0"
      method: "host.get"
      params:
        output: ["hostid", "host", "name", "monitored_by", "proxy_groupid"]
        selectInterfaces: "extend"
        selectTags: "extend"
        selectGroups: ["groupid", "name"]
      auth: "{{ zabbix_auth }}"
      id: 100
  register: zbx_hosts_resp
  run_once: true
  delegate_to: localhost

- name: Display Zabbix hosts fetch results
  debug:
    msg: |
      ============================================
      ZABBIX HOSTS FETCH RESULTS
      ============================================
      Total hosts found: {{ zbx_hosts_resp.json.result | default([]) | length }}
      ============================================
  when: zbx_hosts_resp.json.result is defined

- name: Debug first host tags (RAW)
  debug:
    msg: |
      ============================================
      FIRST HOST RAW TAG DATA
      ============================================
      Host: {{ zbx_hosts_resp.json.result[0].host | default('N/A') }}
      Tags: {{ zbx_hosts_resp.json.result[0].tags | default([]) }}
      Tag count: {{ zbx_hosts_resp.json.result[0].tags | default([]) | length }}
      {% if zbx_hosts_resp.json.result[0].tags | default([]) | length > 0 %}
      First tag structure: {{ zbx_hosts_resp.json.result[0].tags[0] }}
      {% endif %}
      ============================================
  when: 
    - zbx_hosts_resp.json.result is defined
    - zbx_hosts_resp.json.result | length > 0

- name: Build Loki_ID to host mapping (using Python-style iteration)
  set_fact:
    zabbix_hosts_by_loki_id: |
      {%- set mapping = {} -%}
      {%- for host in zbx_hosts_resp.json.result | default([]) -%}
        {%- set loki_tags = host.tags | default([]) | selectattr('tag', 'defined') | selectattr('tag', 'equalto', 'Loki_ID') | list -%}
        {%- if loki_tags | length > 0 -%}
          {%- set loki_id = loki_tags[0].value | string -%}
          {%- set _ = mapping.update({loki_id: host}) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ mapping }}
  run_once: true
  delegate_to: localhost

- name: Debug Loki_ID mapping results
  debug:
    msg: |
      ============================================
      LOKI_ID MAPPING DEBUG
      ============================================
      Total hosts checked: {{ zbx_hosts_resp.json.result | default([]) | length }}
      Hosts with Loki_ID: {{ zabbix_hosts_by_loki_id | default({}) | length }}
      {% if zabbix_hosts_by_loki_id | default({}) | length > 0 %}
      Sample Loki_IDs found: {{ (zabbix_hosts_by_loki_id.keys() | list | sort)[:5] }}
      {% else %}
      WARNING: No Loki_ID tags found in any host!
      {% endif %}
      ============================================
  when: zbx_hosts_resp.json.result is defined

- name: Build hostname to host mapping (fallback)
  set_fact:
    zabbix_hosts_by_hostname: >-
      {%- set mapping = {} -%}
      {%- for host in zbx_hosts_resp.json.result | default([]) -%}
      {%- set _ = mapping.update({host.host: host}) -%}
      {%- endfor -%}
      {{ mapping }}
  run_once: true
  delegate_to: localhost
  when: zbx_hosts_resp.json.result is defined

- name: Display mapping statistics
  debug:
    msg: |
      ============================================
      ZABBIX HOST MAPPING STATISTICS
      ============================================
      Hosts with Loki_ID tag: {{ zabbix_hosts_by_loki_id | default({}) | length }}
      Total hosts: {{ zbx_hosts_resp.json.result | default([]) | length }}
      Hostname mapping size: {{ zabbix_hosts_by_hostname | default({}) | length }}
      ============================================
  when: zbx_hosts_resp.json.result is defined

