---
- name: Create Python script to fetch all devices with pagination
  copy:
    content: |
      #!/usr/bin/env python3
      import json
      import sys
      import requests
      from urllib3.exceptions import InsecureRequestWarning
      
      requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
      
      netbox_url = sys.argv[1].rstrip('/')
      netbox_token = sys.argv[2]
      verify_ssl = sys.argv[3].lower() == 'true'
      device_role_filter = sys.argv[4] if len(sys.argv) > 4 and sys.argv[4] else None
      site_filter = sys.argv[5] if len(sys.argv) > 5 and sys.argv[5] else None
      manufacturer_filter = sys.argv[6] if len(sys.argv) > 6 and sys.argv[6] else None
      
      all_devices = []
      next_url = f"{netbox_url}/api/dcim/devices/?limit=1000"
      
      while next_url:
          try:
              response = requests.get(
                  next_url,
                  headers={
                      'Authorization': f'Token {netbox_token}',
                      'Accept': 'application/json'
                  },
                  verify=verify_ssl,
                  timeout=30
              )
              response.raise_for_status()
              data = response.json()
              
              devices = data.get('results', [])
              
              # Apply filters
              filtered_devices = []
              for device in devices:
                  # Device role filter
                  if device_role_filter:
                      role_name = device.get('device_role', {}).get('name', '') if device.get('device_role') else ''
                      if not role_name or role_name.upper() != device_role_filter.upper():
                          continue
                  
                  # Site filter
                  if site_filter:
                      site_name = device.get('site', {}).get('name', '') if device.get('site') else ''
                      if not site_name or site_name.upper() != site_filter.upper():
                          continue
                  
                  # Manufacturer filter
                  if manufacturer_filter:
                      manufacturer_name = device.get('device_type', {}).get('manufacturer', {}).get('name', '') if device.get('device_type', {}).get('manufacturer') else ''
                      if not manufacturer_name or manufacturer_name.upper() != manufacturer_filter.upper():
                          continue
                  
                  filtered_devices.append(device)
              
              all_devices.extend(filtered_devices)
              next_url = data.get('next')
              
              if not next_url:
                  break
          except Exception as e:
              print(f"Error: {e}", file=sys.stderr)
              sys.exit(1)
      
      result = {
          'devices': all_devices,
          'count': len(all_devices)
      }
      
      print(json.dumps(result))
    dest: "/tmp/fetch_all_netbox_devices.py"
    mode: '0755'
  delegate_to: localhost
  run_once: true

- name: Set filter variables with safe defaults
  set_fact:
    _device_role_filter: "{{ device_role_filter if device_role_filter is defined else '' }}"
    _site_filter: "{{ site_filter if site_filter is defined else '' }}"
    _manufacturer_filter: "{{ manufacturer_filter if manufacturer_filter is defined else '' }}"

- name: Fetch all devices using Python script
  command: >
    python3 /tmp/fetch_all_netbox_devices.py
    "{{ netbox_url }}"
    "{{ netbox_token }}"
    "{{ netbox_verify_ssl | string }}"
    "{{ _device_role_filter }}"
    "{{ _site_filter }}"
    "{{ _manufacturer_filter }}"
  register: fetch_devices_result
  changed_when: false
  delegate_to: localhost

- name: Parse fetched devices
  set_fact:
    netbox_devices_raw: "{{ (fetch_devices_result.stdout | from_json).devices }}"
    netbox_devices_count: "{{ (fetch_devices_result.stdout | from_json).count }}"

