---
- name: Create Python script to fetch all devices with mapping-based filtering
  copy:
    content: |
      #!/usr/bin/env python3
      import json
      import sys
      import requests
      from urllib3.exceptions import InsecureRequestWarning
      
      requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
      
      netbox_url = sys.argv[1].rstrip('/')
      netbox_token = sys.argv[2]
      verify_ssl = sys.argv[3].lower() == 'true'
      mapping_file_path = sys.argv[4]
      location_filter = sys.argv[5] if len(sys.argv) > 5 else ''
      
      # Load device type mapping from file
      with open(mapping_file_path, 'r') as f:
          device_type_mapping = json.load(f)
      mappings = device_type_mapping.get('mappings', [])
      
      # Debug: Print mapping info
      print(f"DEBUG: Loaded {len(mappings)} device type mappings", file=sys.stderr)
      
      def device_matches_conditions(device, conditions):
          """Check if device matches the given conditions"""
          # Device role check - Netbox API uses 'role' field, not 'device_role'
          if 'device_role' in conditions:
              # Try 'role' first (Netbox API field name), then 'device_role' as fallback
              role_obj = device.get('role') or device.get('device_role')
              role_name = role_obj.get('name', '') if role_obj and isinstance(role_obj, dict) else ''
              expected_roles = conditions['device_role']
              if isinstance(expected_roles, list):
                  if not role_name or role_name.upper() not in [r.upper() for r in expected_roles]:
                      return False
              else:
                  if not role_name or role_name.upper() != expected_roles.upper():
                      return False
          
          # Manufacturer check
          if 'manufacturer' in conditions:
              manufacturer_name = device.get('device_type', {}).get('manufacturer', {}).get('name', '') if device.get('device_type', {}).get('manufacturer') else ''
              expected_manufacturers = conditions['manufacturer']
              if isinstance(expected_manufacturers, list):
                  if not manufacturer_name or manufacturer_name.upper() not in [m.upper() for m in expected_manufacturers]:
                      return False
              else:
                  if not manufacturer_name or manufacturer_name.upper() != expected_manufacturers.upper():
                      return False
          
          # Model contains check
          if 'model_contains' in conditions:
              model = device.get('device_type', {}).get('model', '') if device.get('device_type') else ''
              expected_contains = conditions['model_contains']
              if isinstance(expected_contains, list):
                  if not any(contain.upper() in model.upper() for contain in expected_contains):
                      return False
              else:
                  if expected_contains.upper() not in model.upper():
                      return False
          
          # Model suffix check
          if 'model_suffix' in conditions:
              model = device.get('device_type', {}).get('model', '') if device.get('device_type') else ''
              expected_suffix = conditions['model_suffix']
              if not model.upper().endswith(expected_suffix.upper()):
                  return False
          
          # Name contains check
          if 'name_contains' in conditions:
              name = device.get('name', '')
              expected_contains = conditions['name_contains']
              if isinstance(expected_contains, list):
                  if not any(contain.upper() in name.upper() for contain in expected_contains):
                      return False
              else:
                  if expected_contains.upper() not in name.upper():
                      return False
          
          return True
      
      def device_matches_any_mapping(device):
          """Check if device matches any mapping condition"""
          for mapping in mappings:
              conditions = mapping.get('conditions', {})
              if device_matches_conditions(device, conditions):
                  return True
          return False
      
      all_devices = []
      # Build API URL with location filter if provided
      api_url = f"{netbox_url}/api/dcim/devices/?limit=1000"
      if location_filter:
          # Location filter can be by name (location__name) or by ID (location_id)
          # Try to match by name first
          api_url += f"&location__name={location_filter}"
          print(f"DEBUG: Applying location filter: {location_filter}", file=sys.stderr)
      
      next_url = api_url
      
      while next_url:
          try:
              response = requests.get(
                  next_url,
                  headers={
                      'Authorization': f'Token {netbox_token}',
                      'Accept': 'application/json'
                  },
                  verify=verify_ssl,
                  timeout=30
              )
              response.raise_for_status()
              data = response.json()
              
              devices = data.get('results', [])
              
              # Debug: Print page info
              print(f"DEBUG: Fetched {len(devices)} devices from this page", file=sys.stderr)
              
              # Debug: Print sample device details (first 3 devices)
              if len(devices) > 0 and len(all_devices) == 0:  # Only print on first page
                  print("DEBUG: Sample device details (first 3 devices):", file=sys.stderr)
                  for i, device in enumerate(devices[:3]):
                      # Try 'role' first (Netbox API field name), then 'device_role' as fallback
                      role_obj = device.get('role') or device.get('device_role')
                      role_name = role_obj.get('name', 'N/A') if role_obj and isinstance(role_obj, dict) else 'N/A'
                      manufacturer_name = device.get('device_type', {}).get('manufacturer', {}).get('name', 'N/A') if device.get('device_type', {}).get('manufacturer') else 'N/A'
                      model = device.get('device_type', {}).get('model', 'N/A') if device.get('device_type') else 'N/A'
                      name = device.get('name', 'N/A')
                      print(f"  Device {i+1}: name={name}, role={role_name}, manufacturer={manufacturer_name}, model={model}", file=sys.stderr)
              
              # Apply mapping-based filters
              filtered_devices = []
              unmatched_count = 0
              for device in devices:
                  if device_matches_any_mapping(device):
                      filtered_devices.append(device)
                  else:
                      unmatched_count += 1
                      # Debug: Print first unmatched device details for troubleshooting
                      if unmatched_count == 1 and len(all_devices) == 0:
                          # Try 'role' first (Netbox API field name), then 'device_role' as fallback
                          role_obj = device.get('role') or device.get('device_role')
                          role_name = role_obj.get('name', 'N/A') if role_obj and isinstance(role_obj, dict) else 'N/A'
                          manufacturer_name = device.get('device_type', {}).get('manufacturer', {}).get('name', 'N/A') if device.get('device_type', {}).get('manufacturer') else 'N/A'
                          model = device.get('device_type', {}).get('model', 'N/A') if device.get('device_type') else 'N/A'
                          name = device.get('name', 'N/A')
                          print(f"DEBUG: First unmatched device: name={name}, role={role_name}, manufacturer={manufacturer_name}, model={model}", file=sys.stderr)
                          # Check why it doesn't match
                          for mapping in mappings:
                              conditions = mapping.get('conditions', {})
                              print(f"  Checking mapping '{mapping.get('device_type', 'N/A')}':", file=sys.stderr)
                              if 'device_role' in conditions:
                                  expected_role = conditions['device_role']
                                  if isinstance(expected_role, list):
                                      print(f"    device_role: expected one of {expected_role}, got '{role_name}'", file=sys.stderr)
                                  else:
                                      print(f"    device_role: expected '{expected_role}', got '{role_name}'", file=sys.stderr)
                              if 'manufacturer' in conditions:
                                  expected_manufacturer = conditions['manufacturer']
                                  if isinstance(expected_manufacturer, list):
                                      print(f"    manufacturer: expected one of {expected_manufacturer}, got '{manufacturer_name}'", file=sys.stderr)
                                  else:
                                      print(f"    manufacturer: expected '{expected_manufacturer}', got '{manufacturer_name}'", file=sys.stderr)
                              if 'model_contains' in conditions:
                                  expected_contains = conditions['model_contains']
                                  print(f"    model_contains: expected {expected_contains}, got model '{model}'", file=sys.stderr)
                              if 'model_suffix' in conditions:
                                  expected_suffix = conditions['model_suffix']
                                  print(f"    model_suffix: expected '{expected_suffix}', got model '{model}'", file=sys.stderr)
                          break
              
              all_devices.extend(filtered_devices)
              print(f"DEBUG: After mapping filters, {len(filtered_devices)} devices match on this page", file=sys.stderr)
              next_url = data.get('next')
              
              if not next_url:
                  break
          except Exception as e:
              print(f"Error: {e}", file=sys.stderr)
              sys.exit(1)
      
      # Debug: Print final results
      print(f"DEBUG: Total devices after mapping filters: {len(all_devices)}", file=sys.stderr)
      
      result = {
          'devices': all_devices,
          'count': len(all_devices)
      }
      
      print(json.dumps(result))
    dest: "/tmp/fetch_all_netbox_devices.py"
    mode: '0755'
  delegate_to: localhost
  run_once: true

- name: Save device type mapping to temporary file
  copy:
    content: "{{ device_type_mapping | to_json }}"
    dest: "/tmp/netbox_device_type_mapping.json"
  delegate_to: localhost
  run_once: true

- name: Display mapping-based filtering info
  debug:
    msg: |
      ============================================
      MAPPING-BASED FILTERING
      ============================================
      Using device type mapping file: {{ device_type_mapping_path }}
      Total mappings loaded: {{ device_type_mapping.mappings | length }}
      Mappings:
      {% for mapping in device_type_mapping.mappings %}
      - {{ mapping.device_type }}: {{ mapping.conditions | to_nice_json }}
      {% endfor %}
      ============================================

- name: Fetch all devices using Python script with mapping-based filtering
  command: >
    python3 /tmp/fetch_all_netbox_devices.py
    "{{ netbox_url }}"
    "{{ netbox_token }}"
    "{{ netbox_verify_ssl | string }}"
    "/tmp/netbox_device_type_mapping.json"
    "{{ location_filter | default('') }}"
  register: fetch_devices_result
  changed_when: false
  delegate_to: localhost

- name: Display Python script debug output
  debug:
    msg: "{{ fetch_devices_result.stderr_lines | default([]) | join('\n') }}"
  when: fetch_devices_result.stderr_lines is defined and fetch_devices_result.stderr_lines | length > 0

- name: Parse fetched devices
  set_fact:
    netbox_devices_raw: "{{ (fetch_devices_result.stdout | from_json).devices }}"
    netbox_devices_count: "{{ (fetch_devices_result.stdout | from_json).count }}"

- name: Display fetch results
  debug:
    msg: |
      ============================================
      NETBOX API FETCH RESULTS
      ============================================
      Total devices found after filters: {{ netbox_devices_count }}
      Raw devices list length: {{ netbox_devices_raw | length }}
      ============================================

