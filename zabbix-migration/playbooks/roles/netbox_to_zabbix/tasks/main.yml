---
- name: Load template mappings
  set_fact:
    templates_map: "{{ lookup('file', templates_map_path) | from_yaml }}"
    datacenters_map: "{{ lookup('file', datacenters_map_path) | from_yaml }}"
    device_type_mapping: "{{ lookup('file', device_type_mapping_path) | from_yaml }}"

- name: Fetch all devices from Netbox API (with pagination and role filter)
  include_tasks: fetch_all_devices.yml

- name: Set filtered devices
  set_fact:
    netbox_devices_filtered: "{{ netbox_devices_raw }}"

- name: Apply site filter
  set_fact:
    netbox_devices_filtered: >-
      {{ netbox_devices_filtered | selectattr('site.name', 'equalto', site_filter) | list }}
  when: 
    - site_filter is defined
    - site_filter | string | length > 0

- name: Apply manufacturer filter
  set_fact:
    netbox_devices_filtered: >-
      {{ netbox_devices_filtered | selectattr('device_type.manufacturer.name', 'equalto', manufacturer_filter) | list }}
  when: 
    - manufacturer_filter is defined
    - manufacturer_filter | string | length > 0

- name: Apply device limit
  set_fact:
    netbox_devices_final: "{{ netbox_devices_filtered[:device_limit] }}"
  when: device_limit > 0

- name: Set all devices when no limit
  set_fact:
    netbox_devices_final: "{{ netbox_devices_filtered }}"
  when: device_limit == 0

- name: Display device count
  debug:
    msg: "Found {{ netbox_devices_final | length }} devices to process (limit: {{ 'unlimited' if device_limit == 0 else device_limit }})"

- name: Process each device
  include_tasks: process_device.yml
  loop: "{{ netbox_devices_final }}"
  loop_control:
    label: "{{ item.name | default('Unknown') }}"
  vars:
    netbox_device: "{{ item }}"
