---
- name: Ensure device_limit is an integer
  set_fact:
    device_limit: "{{ device_limit | default(0) | int }}"

- name: Load template mappings
  set_fact:
    templates_map: "{{ lookup('file', templates_map_path) | from_yaml }}"
    datacenters_map: "{{ lookup('file', datacenters_map_path) | from_yaml }}"
    device_type_mapping: "{{ lookup('file', device_type_mapping_path) | from_yaml }}"

- name: Fetch all devices from Netbox API (with pagination and role filter)
  include_tasks: fetch_all_devices.yml

- name: Set filtered devices (filters already applied in Python script)
  set_fact:
    netbox_devices_filtered: "{{ netbox_devices_raw }}"
    device_limit_int: "{{ device_limit | int }}"

- name: Apply device limit
  set_fact:
    netbox_devices_final: "{{ netbox_devices_filtered[:device_limit_int] }}"
  when: device_limit_int > 0

- name: Set all devices when no limit
  set_fact:
    netbox_devices_final: "{{ netbox_devices_filtered }}"
  when: device_limit_int == 0

- name: Display device count
  debug:
    msg: "Found {{ netbox_devices_final | length }} devices to process (limit: {{ 'unlimited' if device_limit_int == 0 else device_limit_int }})"

- name: Process each device
  include_tasks: process_device.yml
  loop: "{{ netbox_devices_final }}"
  loop_control:
    label: "{{ item.name | default('Unknown') }}"
  vars:
    netbox_device: "{{ item }}"
