---
- name: Load mappings
  vars:
    _tpl_map_path: "{{ playbook_dir | default(ansible_playbook_directory) }}/../mappings/templates.yml"
    _type_map_path: "{{ playbook_dir | default(ansible_playbook_directory) }}/../mappings/template_types.yml"
    _dc_map_path: "{{ playbook_dir | default(ansible_playbook_directory) }}/../mappings/datacenters.yml"
  set_fact:
    zbx_tpl_map: "{{ lookup('file', _tpl_map_path) | from_yaml }}"
    zbx_type_map: "{{ lookup('file', _type_map_path) | from_yaml }}"
    zbx_dc_map: "{{ lookup('file', _dc_map_path) | from_yaml }}"

- name: Parse macros field
  vars:
    macros_raw: "{{ zbx_record.MACROS | default('') }}"
    macros_json_like: "{{ macros_raw | regex_replace('^\\s*$','{}') | regex_replace('^{\\s*','{') | regex_replace('\\s*}$','}') }}"
  set_fact:
    zbx_macros: >-
      {{ (macros_json_like | from_yaml) if macros_json_like is match('^\\{') else {} }}

- name: Parse tags from macros field
  vars:
    _macros_dict: "{{ zbx_macros | default({}) }}"
  set_fact:
    zbx_tags: >-
      {{ _macros_dict | dict2items | map('dict', tag='key', value='value') | list }}
  when: _macros_dict | length > 0

- name: Initialize tags if empty
  set_fact:
    zbx_tags: []
  when: zbx_tags is not defined

- name: Resolve templates for device type
  set_fact:
    zbx_templates: "{{ zbx_tpl_map.get(zbx_record.DEVICE_TYPE, []) }}"

- name: Extract template names and types
  set_fact:
    zbx_template_names: "{{ zbx_templates | map(attribute='name') | list }}"
    zbx_template_types: "{{ zbx_templates | map(attribute='type') | list | unique }}"

- name: Fail if no templates found for device type
  when: zbx_template_names | length == 0
  fail:
    msg: "No templates mapped for DEVICE_TYPE='{{ zbx_record.DEVICE_TYPE }}'"

- name: Determine interface type from templates
  set_fact:
    zbx_iface_type: "{{ zbx_template_types[0] }}"

- name: Warn if multiple differing interface types found
  when: zbx_template_types | length > 1
  debug:
    msg: "Multiple template types found {{ zbx_template_types }}; using '{{ zbx_iface_type }}'"

- name: Resolve interface spec
  set_fact:
    zbx_iface: "{{ zbx_type_map.get(zbx_iface_type, {}).get('interface') }}"

- name: Resolve DC proxy
  set_fact:
    zbx_dc: "{{ zbx_dc_map.get(zbx_record.DC_ID, {}) }}"

- name: Determine monitored_by based on DC proxy mapping
  set_fact:
    zbx_monitored_by: "{{ 2 if (zbx_dc.proxyid is defined or zbx_dc.proxy_groupid is defined) else 0 }}"

- name: Resolve template IDs by name
  vars:
    _tpl_get_body: |
      {
        "jsonrpc": "2.0",
        "method": "template.get",
        "params": {"output": ["templateid","name"], "filter": {"name": %s}},
        "auth": "%s",
        "id": 1001
      }
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    validate_certs: false
    body: "{{ _tpl_get_body | format(zbx_template_names | to_json, zabbix_auth) | from_json }}"
  register: zbx_tpl_get_resp

- name: Init template id list
  set_fact:
    zbx_template_id_list: []

- name: Append each templateid as dict
  set_fact:
    zbx_template_id_list: "{{ zbx_template_id_list + [ { 'templateid': item } ] }}"
  loop: "{{ zbx_tpl_get_resp.json.result | map(attribute='templateid') | list }}"

- name: Collect required host groups for this record
  vars:
    _csv_group_names: "{{ (zbx_record.HOST_GROUPS | default('')).split(',') | map('trim') | reject('equalto', '') | list }}"
    _all_target_groups: "{{ (_csv_group_names + [zbx_record.DEVICE_TYPE]) | unique }}"
  set_fact:
    zbx_required_groups_for_record: "{{ _all_target_groups }}"

- name: Ensure zbx_group_map exists (create if missing)
  when: zbx_group_map is not defined
  block:
    - name: Get existing host groups from Zabbix
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json
        validate_certs: "{{ zabbix_validate_certs | default(false) }}"
        body:
          jsonrpc: "2.0"
          method: "hostgroup.get"
          params:
            output: ["groupid", "name"]
            filter:
              name: "{{ zbx_required_groups_for_record }}"
          auth: "{{ zabbix_auth }}"
          id: 101
      register: zbx_existing_groups_resp
      run_once: true
      delegate_to: localhost

    - name: Identify missing groups
      vars:
        _existing_names: "{{ zbx_existing_groups_resp.json.result | map(attribute='name') | list }}"
      set_fact:
        zbx_missing_groups: "{{ zbx_required_groups_for_record | difference(_existing_names) }}"
      run_once: true
      delegate_to: localhost

    - name: Create missing host groups
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json
        validate_certs: "{{ zabbix_validate_certs | default(false) }}"
        body:
          jsonrpc: "2.0"
          method: "hostgroup.create"
          params:
            name: "{{ item }}"
          auth: "{{ zabbix_auth }}"
          id: 102
      loop: "{{ zbx_missing_groups }}"
      register: zbx_created_groups_resp
      when: zbx_missing_groups | length > 0
      run_once: true
      delegate_to: localhost

    - name: Refresh host groups map (Fetch all required groups again to get IDs)
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json
        validate_certs: "{{ zabbix_validate_certs | default(false) }}"
        body:
          jsonrpc: "2.0"
          method: "hostgroup.get"
          params:
            output: ["groupid", "name"]
            filter:
              name: "{{ zbx_required_groups_for_record }}"
          auth: "{{ zabbix_auth }}"
          id: 103
      register: zbx_final_groups_resp
      run_once: true
      delegate_to: localhost

    - name: Build Group Name-to-ID Map
      set_fact:
        zbx_group_map: "{{ zbx_final_groups_resp.json.result | items2dict(key_name='name', value_name='groupid') }}"
      run_once: true
      delegate_to: localhost

- name: Initialize group ID list
  set_fact:
    zbx_group_id_list: []

- name: Resolve Group IDs from map
  vars:
    _csv_group_names: "{{ (zbx_record.HOST_GROUPS | default('')).split(',') | map('trim') | reject('equalto', '') | list }}"
    _all_target_groups: "{{ (_csv_group_names + [zbx_record.DEVICE_TYPE]) | unique }}"
  set_fact:
    zbx_group_id_list: "{{ zbx_group_id_list + [zbx_group_map[group_name]] }}"
  loop: "{{ _all_target_groups }}"
  loop_control:
    loop_var: group_name
  when: group_name is defined and group_name in zbx_group_map

- name: Create or update host via Zabbix API
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    validate_certs: false
    body:
      jsonrpc: "2.0"
      method: "host.create"
      params:
        host: "{{ zbx_record.HOSTNAME }}"
        name: "{{ zbx_record.HOSTNAME }}"
        interfaces: >-
          {{ [ {
            'type': zbx_iface.type,
            'main': 1,
            'useip': 1,
            'ip': zbx_record.HOST_IP,
            'dns': zbx_iface.dns | default(''),
            'port': (zbx_iface.port | default(161)) | string,
            'details': zbx_iface.details | default(omit)
          } ] if zbx_iface is not none else [] }}
        templates: "{{ zbx_template_id_list }}"
        groups: "{{ zbx_group_id_list | map('regex_replace','^(.*)$','{\"groupid\":\"\\1\"}') | map('from_yaml') | list }}"
        tags: "{{ zbx_tags | default(omit) }}"
        monitored_by: "{{ zbx_monitored_by }}"
        proxy_groupid: "{{ zbx_dc.proxy_groupid | default(omit) }}"
        proxyid: "{{ zbx_dc.proxyid | default(omit) }}"
      auth: "{{ zabbix_auth }}"
      id: 1
  register: zbx_create_resp
  failed_when: false

- name: If host exists, update instead
  when: zbx_create_resp.json.error is defined and zbx_create_resp.json.error.message is search('already exists')
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    validate_certs: false
    body:
      jsonrpc: "2.0"
      method: "host.update"
      params:
        host: "{{ zbx_record.HOSTNAME }}"
        name: "{{ zbx_record.HOSTNAME }}"
        interfaces: >-
          {{ [ {
            'type': zbx_iface.type,
            'main': 1,
            'useip': 1,
            'ip': zbx_record.HOST_IP,
            'dns': zbx_iface.dns | default(''),
            'port': (zbx_iface.port | default(161)) | string,
            'details': zbx_iface.details | default(omit)
          } ] if zbx_iface is not none else omit }}
        templates: "{{ zbx_template_id_list }}"
        groups: "{{ zbx_group_id_list | map('regex_replace','^(.*)$','{\"groupid\":\"\\1\"}') | map('from_yaml') | list }}"
        tags: "{{ zbx_tags | default(omit) }}"
        monitored_by: "{{ zbx_monitored_by }}"
        proxy_groupid: "{{ zbx_dc.proxy_groupid | default(omit) }}"
        proxyid: "{{ zbx_dc.proxyid | default(omit) }}"
      auth: "{{ zabbix_auth }}"
      id: 2
  register: zbx_update_resp
