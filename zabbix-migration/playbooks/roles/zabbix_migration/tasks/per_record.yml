---
- name: Reset per-record variables
  set_fact:
    _existing_interface: {}
    _interface_id: ""
    _zbx_interface_update: []
    _needs_update: false
    _updated_fields: ""
  run_once: false

- name: Load mappings
  vars:
    _tpl_map_path: "{{ playbook_dir | default(ansible_playbook_directory) }}/../mappings/templates.yml"
    _type_map_path: "{{ playbook_dir | default(ansible_playbook_directory) }}/../mappings/template_types.yml"
    _dc_map_path: "{{ playbook_dir | default(ansible_playbook_directory) }}/../mappings/datacenters.yml"
  set_fact:
    zbx_tpl_map: "{{ lookup('file', _tpl_map_path) | from_yaml }}"
    zbx_type_map: "{{ lookup('file', _type_map_path) | from_yaml }}"
    zbx_dc_map: "{{ lookup('file', _dc_map_path) | from_yaml }}"

- name: Set default scenario if not provided
  set_fact:
    zbx_scenario: "{{ zbx_scenario | default('create') }}"
    zbx_existing_host: "{{ zbx_existing_host | default({}) }}"

- name: Parse tags from MACROS field
  vars:
    macros_raw: "{{ zbx_record.MACROS | default({}) }}"
    _macros_dict: "{{ macros_raw if macros_raw is mapping else (macros_raw | from_json if macros_raw is string else {}) }}"
  set_fact:
    zbx_tags: >-
      {%- if _macros_dict is mapping and _macros_dict | length > 0 -%}
      {%- set _tags = [] -%}
      {%- for key, value in _macros_dict.items() -%}
      {%- set _ = _tags.append({'tag': key, 'value': value | string}) -%}
      {%- endfor -%}
      {{ _tags }}
      {%- else -%}
      []
      {%- endif -%}

- name: Resolve templates for device type
  set_fact:
    zbx_templates: "{{ zbx_tpl_map.get(zbx_record.DEVICE_TYPE, []) }}"

- name: Extract template names and types
  set_fact:
    zbx_template_names: "{{ zbx_templates | map(attribute='name') | list }}"
    zbx_template_types: "{{ zbx_templates | map(attribute='type') | list | unique }}"

- name: Fail if no templates found for device type
  fail:
    msg: "No templates mapped for DEVICE_TYPE='{{ zbx_record.DEVICE_TYPE }}'"
  when: zbx_template_names | length == 0

- name: Determine interface type from templates
  set_fact:
    zbx_iface_type: "{{ zbx_template_types[0] }}"

- name: Warn if multiple differing interface types found
  debug:
    msg: "Multiple template types found {{ zbx_template_types }}; using '{{ zbx_iface_type }}'"
  when: zbx_template_types | length > 1

- name: Resolve interface spec
  set_fact:
    zbx_iface: "{{ zbx_type_map.get(zbx_iface_type, {}).get('interface') }}"

- name: Get all proxy groups from Zabbix (if not already fetched)
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    validate_certs: "{{ zabbix_validate_certs | default(false) }}"
    body:
      jsonrpc: "2.0"
      method: "proxygroup.get"
      params:
        output: ["proxy_groupid", "name"]
      auth: "{{ zabbix_auth }}"
      id: 104
  register: zbx_proxy_groups_resp
  run_once: true
  delegate_to: localhost
  when: zbx_proxy_group_map is not defined

- name: Build proxy group name to ID map (if not already built)
  set_fact:
    zbx_proxy_group_map: "{{ zbx_proxy_groups_resp.json.result | items2dict(key_name='name', value_name='proxy_groupid') }}"
  run_once: true
  delegate_to: localhost
  when: zbx_proxy_group_map is not defined

- name: Resolve proxy group by location (DC_ID)
  vars:
    location_name: "{{ zbx_record.DC_ID | default('') }}"
    _dc_number: "{{ (location_name | upper | regex_replace('.*DC([0-9]+).*', '\\1')) if location_name else '' }}"
  set_fact:
    zbx_location_name: "{{ location_name }}"
    zbx_dc_number: "{{ _dc_number }}"
    zbx_matched_proxy_group: ""
    zbx_proxy_group_id: ""
    zbx_monitored_by: "0"

- name: Find matching proxy group
  vars:
    pg_name: "{{ proxy_group_item }}"
    pg_upper: "{{ proxy_group_item | upper }}"
    # Extract DC ID (supports both numeric like "DC11" and alphanumeric like "ICT11")
    # First remove '-PROXY...' suffix, then remove 'DC' prefix if exists
    pg_dc_num: "{{ pg_upper | regex_replace('[-\\s]*PROXY.*$', '') | regex_replace('^DC', '') | trim }}"
  set_fact:
    zbx_matched_proxy_group: "{{ proxy_group_item }}"
    zbx_proxy_group_id: "{{ zbx_proxy_group_map[proxy_group_item] }}"
    zbx_monitored_by: "2"
  loop: "{{ zbx_proxy_group_map.keys() | list if zbx_proxy_group_map is defined else [] }}"
  loop_control:
    loop_var: proxy_group_item
    label: "{{ proxy_group_item }} (DC: {{ pg_dc_num }}, Match: {{ (zbx_dc_number | string | upper == pg_dc_num | string | upper) | bool }})"
  when: 
    - zbx_dc_number is defined
    - zbx_dc_number != ''
    - zbx_dc_number | string | upper == pg_dc_num | string | upper

- name: Debug proxy group matching
  vars:
    _test_pg_numeric: "Dc14-proxy Group"
    _test_pg_alpha: "Ict11-Proxy Group"
    _test_upper_numeric: "{{ _test_pg_numeric | upper }}"
    _test_upper_alpha: "{{ _test_pg_alpha | upper }}"
    _test_dc_num_numeric: "{{ _test_upper_numeric | regex_replace('[-\\s]*PROXY.*$', '') | regex_replace('^DC', '') | trim }}"
    _test_dc_num_alpha: "{{ _test_upper_alpha | regex_replace('[-\\s]*PROXY.*$', '') | regex_replace('^DC', '') | trim }}"
  debug:
    msg: |
      Location: {{ zbx_location_name }}
      DC Number: {{ zbx_dc_number }}
      Matched proxy group: {{ zbx_matched_proxy_group }}
      Proxy group ID: {{ zbx_proxy_group_id }}
      Test Numeric - PG: {{ _test_pg_numeric }}, Upper: {{ _test_upper_numeric }}, Extracted: {{ _test_dc_num_numeric }}
      Test Alpha - PG: {{ _test_pg_alpha }}, Upper: {{ _test_upper_alpha }}, Extracted: {{ _test_dc_num_alpha }}
      Available proxy groups: {{ zbx_proxy_group_map.keys() | list if zbx_proxy_group_map is defined else [] }}

- name: Debug template names
  debug:
    msg: "Looking for templates: {{ zbx_template_names }}"

- name: Resolve template IDs by name
  vars:
    _tpl_get_body: |
      {
        "jsonrpc": "2.0",
        "method": "template.get",
        "params": {"output": ["templateid","name"], "filter": {"name": %s}},
        "auth": "%s",
        "id": 1001
      }
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    validate_certs: "{{ zabbix_validate_certs | default(false) }}"
    body: "{{ _tpl_get_body | format(zbx_template_names | to_json, zabbix_auth) | from_json }}"
  register: zbx_tpl_get_resp

- name: Debug template response
  debug:
    msg: "Template response: {{ zbx_tpl_get_resp.json.result | default([]) }}"

- name: Init template id list
  set_fact:
    zbx_template_id_list: []

- name: Append each templateid as dict
  set_fact:
    zbx_template_id_list: "{{ zbx_template_id_list + [ { 'templateid': template_item } ] }}"
  loop: "{{ zbx_tpl_get_resp.json.result | default([]) | map(attribute='templateid') | list }}"
  loop_control:
    loop_var: template_item
  when: zbx_tpl_get_resp.json.result is defined and zbx_tpl_get_resp.json.result | length > 0

- name: Warn if no templates found
  debug:
    msg: "WARNING: No templates found for device type '{{ zbx_record.DEVICE_TYPE }}'. Template names searched: {{ zbx_template_names }}"
  when: zbx_template_id_list | length == 0

- name: Collect required host groups for this record
  vars:
    _csv_group_names: "{{ (zbx_record.HOST_GROUPS | default('')).split(',') | map('trim') | reject('equalto', '') | list }}"
    _all_target_groups: "{{ (_csv_group_names + [zbx_record.DEVICE_TYPE]) | unique }}"
  set_fact:
    zbx_required_groups_for_record: "{{ _all_target_groups }}"

- name: Ensure zbx_group_map exists (create if missing)
  when: zbx_group_map is not defined
  block:
    - name: Get existing host groups from Zabbix
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json
        validate_certs: "{{ zabbix_validate_certs | default(false) }}"
        body:
          jsonrpc: "2.0"
          method: "hostgroup.get"
          params:
            output: ["groupid", "name"]
            filter:
              name: "{{ zbx_required_groups_for_record }}"
          auth: "{{ zabbix_auth }}"
          id: 101
      register: zbx_existing_groups_resp
      run_once: true
      delegate_to: localhost

    - name: Identify missing groups
      vars:
        _existing_names: "{{ zbx_existing_groups_resp.json.result | map(attribute='name') | list }}"
      set_fact:
        zbx_missing_groups: "{{ zbx_required_groups_for_record | difference(_existing_names) }}"
      run_once: true
      delegate_to: localhost

    - name: Create missing host groups
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json
        validate_certs: "{{ zabbix_validate_certs | default(false) }}"
        body:
          jsonrpc: "2.0"
          method: "hostgroup.create"
          params:
            name: "{{ missing_group_item }}"
          auth: "{{ zabbix_auth }}"
          id: 102
      loop: "{{ zbx_missing_groups }}"
      loop_control:
        loop_var: missing_group_item
      register: zbx_created_groups_resp
      run_once: true
      delegate_to: localhost
      when: zbx_missing_groups | length > 0

    - name: Refresh host groups map (Fetch all required groups again to get IDs)
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json
        validate_certs: "{{ zabbix_validate_certs | default(false) }}"
        body:
          jsonrpc: "2.0"
          method: "hostgroup.get"
          params:
            output: ["groupid", "name"]
            filter:
              name: "{{ zbx_required_groups_for_record }}"
          auth: "{{ zabbix_auth }}"
          id: 103
      register: zbx_final_groups_resp
      run_once: true
      delegate_to: localhost

    - name: Build Group Name-to-ID Map
      set_fact:
        zbx_group_map: "{{ zbx_final_groups_resp.json.result | items2dict(key_name='name', value_name='groupid') }}"
      run_once: true
      delegate_to: localhost

- name: Initialize group ID list
  set_fact:
    zbx_group_id_list: []
    zbx_groups_formatted: []

- name: Resolve Group IDs from map
  vars:
    _csv_group_names: "{{ (zbx_record.HOST_GROUPS | default('')).split(',') | map('trim') | reject('equalto', '') | list }}"
    _all_target_groups: "{{ (_csv_group_names + [zbx_record.DEVICE_TYPE]) | unique }}"
  set_fact:
    zbx_group_id_list: "{{ zbx_group_id_list + [zbx_group_map[group_name]] }}"
    zbx_groups_formatted: "{{ zbx_groups_formatted + [{'groupid': zbx_group_map[group_name]}] }}"
  loop: "{{ _all_target_groups }}"
  loop_control:
    loop_var: group_name
  when: group_name is defined and group_name in zbx_group_map

- name: Extract continuous tags (all tags from Loki)
  set_fact:
    zbx_continuous_tags: "{{ zbx_tags | default([]) }}"
  when: zbx_tags is defined

- name: Preserve manual tags if updating existing host
  set_fact:
    zbx_manual_tags: "{{ zbx_existing_host.tags | default([]) | rejectattr('tag', 'equalto', 'Loki_ID') | selectattr('tag', 'not in', zbx_tags | default([]) | map(attribute='tag') | list) | list }}"
  when:
    - zbx_scenario == 'update'
    - zbx_existing_host is defined
    - zbx_existing_host.tags is defined

- name: Merge Loki tags with manual tags for update
  set_fact:
    zbx_continuous_tags: "{{ (zbx_continuous_tags | default([])) + (zbx_manual_tags | default([])) }}"
  when:
    - zbx_scenario == 'update'
    - zbx_manual_tags is defined

- name: Validate required parameters before create
  set_fact:
    _missing_params: []
    _validation_errors: []
  when: zbx_scenario == 'create'

- name: Check if hostname is missing
  set_fact:
    _missing_params: "{{ _missing_params + ['host'] }}"
    _validation_errors: "{{ _validation_errors + ['Hostname eksik'] }}"
  when:
    - zbx_scenario == 'create'
    - zbx_record.HOSTNAME is not defined or zbx_record.HOSTNAME == ""

- name: Check if IP is missing
  set_fact:
    _missing_params: "{{ _missing_params + ['ip'] }}"
    _validation_errors: "{{ _validation_errors + ['IP adresi eksik'] }}"
  when:
    - zbx_scenario == 'create'
    - zbx_record.HOST_IP is not defined or zbx_record.HOST_IP == ""

- name: Check if template is missing
  set_fact:
    _missing_params: "{{ _missing_params + ['template'] }}"
    _validation_errors: "{{ _validation_errors + ['Template bulunamadı'] }}"
  when:
    - zbx_scenario == 'create'
    - zbx_template_id_list | default([]) | length == 0

- name: Check if proxy group is missing (when DC_ID is provided)
  vars:
    _error_msg: "Proxy group bulunamadı (DC_ID: {{ zbx_record.DC_ID | default('N/A') }})"
  set_fact:
    _missing_params: "{{ _missing_params + ['proxy group'] }}"
    _validation_errors: "{{ _validation_errors + [_error_msg] }}"
  when:
    - zbx_scenario == 'create'
    - zbx_record.DC_ID is defined
    - zbx_record.DC_ID != ""
    - zbx_proxy_group_id is not defined or zbx_proxy_group_id == ""

- name: Record validation failure
  set_fact:
    device_result:
      hostname: "{{ zbx_record.HOSTNAME | default('N/A') }}"
      status: "eklenemedi"
      reason: "{{ _validation_errors | join(', ') }}"
      ip: "{{ zbx_record.HOST_IP | default('N/A') }}"
  when:
    - zbx_scenario == 'create'
    - _missing_params | default([]) | length > 0

- name: Build interface for create
  set_fact:
    _zbx_interface_create: "{{ [{'type': zbx_iface.type, 'main': 1, 'useip': 1, 'ip': zbx_record.HOST_IP, 'dns': zbx_iface.dns | default(''), 'port': (zbx_iface.port | default(161)) | string, 'details': zbx_iface.details | default(omit)}] if zbx_iface is not none else [] }}"
  when:
    - zbx_scenario == 'create'
    - _missing_params | default([]) | length == 0

- name: Create new host (scenario create)
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    validate_certs: "{{ zabbix_validate_certs | default(false) }}"
    body:
      jsonrpc: "2.0"
      method: "host.create"
      params:
        host: "{{ zbx_record.HOSTNAME }}"
        name: "{{ zbx_record.HOSTNAME }}"
        interfaces: "{{ _zbx_interface_create }}"
        templates: "{{ zbx_template_id_list }}"
        groups: "{{ zbx_groups_formatted | default([]) }}"
        tags: "{{ zbx_tags | default(omit) }}"
        monitored_by: "{{ zbx_monitored_by }}"
        proxy_groupid: "{{ zbx_proxy_group_id if (zbx_proxy_group_id is defined and zbx_proxy_group_id != '') else omit }}"
      auth: "{{ zabbix_auth }}"
      id: 1
  register: zbx_create_resp
  failed_when: false
  when:
    - zbx_scenario == 'create'
    - _missing_params | default([]) | length == 0

- name: Record create success
  set_fact:
    device_result:
      hostname: "{{ zbx_record.HOSTNAME }}"
      status: "eklendi"
      reason: ""
      ip: "{{ zbx_record.HOST_IP }}"
  when:
    - zbx_scenario == 'create'
    - _missing_params | default([]) | length == 0
    - zbx_create_resp.json.result is defined
    - zbx_create_resp.json.error is not defined

- name: Record create failure
  set_fact:
    device_result:
      hostname: "{{ zbx_record.HOSTNAME }}"
      status: "eklenemedi"
      reason: "{{ zbx_create_resp.json.error.message | default('Bilinmeyen hata') }}"
      ip: "{{ zbx_record.HOST_IP }}"
  when:
    - zbx_scenario == 'create'
    - _missing_params | default([]) | length == 0
    - zbx_create_resp.json.error is defined

- name: Handle create error (host already exists fallback)
  set_fact:
    zbx_scenario: "update"
    zbx_existing_host: "{{ zabbix_hosts_by_hostname.get(zbx_record.HOSTNAME) | default({}) }}"
  when:
    - zbx_scenario == 'create'
    - zbx_create_resp.json.error is defined
    - zbx_create_resp.json.error.message is search('already exists')
    - zabbix_hosts_by_hostname is defined

- name: Validate required parameters before update
  set_fact:
    _missing_params: >-
      {{
        (_missing_params | default([])) +
        (['Proxy Group (DC_ID: ' + zbx_dc_number + ')'] if (zbx_dc_number is defined and zbx_dc_number != '' and (zbx_proxy_group_id is not defined or zbx_proxy_group_id == '')) else [])
      }}
  when: 
    - zbx_scenario == 'update'
    - zbx_existing_host.hostid is defined

- name: Record validation failure (update scenario)
  set_fact:
    device_result:
      hostname: "{{ zbx_record.HOSTNAME }}"
      status: "eklenemedi"
      reason: "{{ 'Proxy group bulunamadı (DC_ID: ' + zbx_dc_number + ')' if (zbx_dc_number is defined and zbx_dc_number != '' and (zbx_proxy_group_id is not defined or zbx_proxy_group_id == '')) else 'Gerekli parametreler eksik: ' + (_missing_params | default([]) | join(', ')) }}"
      ip: "{{ zbx_record.HOST_IP | default('N/A') }}"
  when:
    - zbx_scenario == 'update'
    - zbx_existing_host.hostid is defined
    - _missing_params | default([]) | length > 0

- name: Get existing interface for update
  set_fact:
    _existing_interface: "{{ zbx_existing_host.interfaces[0] | default({}) if (zbx_existing_host.interfaces | default([]) | length > 0) else {} }}"
    _interface_id: "{{ zbx_existing_host.interfaces[0].interfaceid | default('') if (zbx_existing_host.interfaces | default([]) | length > 0) else '' }}"
  when:
    - zbx_scenario == 'update'
    - zbx_existing_host is defined
    - zbx_existing_host.hostid is defined

- name: Build interface for update
  set_fact:
    _zbx_interface_update: "{{ [{'interfaceid': _interface_id, 'type': zbx_iface.type, 'main': 1, 'useip': 1, 'ip': zbx_record.HOST_IP, 'dns': zbx_iface.dns | default(''), 'port': (zbx_iface.port | default(161)) | string, 'details': zbx_iface.details | default(omit)}] if zbx_iface is not none else omit }}"
  when:
    - zbx_scenario == 'update'
    - zbx_existing_host is defined
    - zbx_existing_host.hostid is defined
    - _interface_id is defined
    - _interface_id != ''
    - _missing_params | default([]) | length == 0

- name: Check if update is needed (compare with existing values)
  set_fact:
    _needs_update: >-
      {{
        (
          (_existing_interface.ip | default('') != zbx_record.HOST_IP) or
          (zbx_existing_host.host | default('') != zbx_record.HOSTNAME) or
          (zbx_existing_host.name | default('') != zbx_record.HOSTNAME) or
          (zbx_existing_host.monitored_by | default('') | string != zbx_monitored_by | string) or
          (zbx_existing_host.proxy_groupid | default('') | string != zbx_proxy_group_id | string) or
          (zbx_existing_host.tags | default([]) | to_json != zbx_continuous_tags | to_json)
        ) | bool
      }}
  when:
    - zbx_scenario == 'update'
    - zbx_existing_host is defined
    - zbx_existing_host.hostid is defined
    - _interface_id is defined
    - _interface_id != ''
    - _missing_params | default([]) | length == 0

- name: Debug update check
  debug:
    msg: |
      Host: {{ zbx_record.HOSTNAME }}
      Needs update: {{ _needs_update | default('not_checked') }}
      Current IP: {{ _existing_interface.ip | default('N/A') }} -> New IP: {{ zbx_record.HOST_IP }}
      Current monitored_by: {{ zbx_existing_host.monitored_by | default('N/A') }} -> New: {{ zbx_monitored_by }}
      Current proxy_groupid: {{ zbx_existing_host.proxy_groupid | default('N/A') }} -> New: {{ zbx_proxy_group_id }}
  when:
    - zbx_scenario == 'update'
    - zbx_existing_host.hostid is defined

- name: Update existing host (scenario update - only continuous fields)
  uri:
    url: "{{ zabbix_url }}"
    method: POST
    body_format: json
    validate_certs: "{{ zabbix_validate_certs | default(false) }}"
    body:
      jsonrpc: "2.0"
      method: "host.update"
      params:
        hostid: "{{ zbx_existing_host.hostid }}"
        host: "{{ zbx_record.HOSTNAME }}"
        name: "{{ zbx_record.HOSTNAME }}"
        interfaces: "{{ _zbx_interface_update }}"
        tags: "{{ zbx_continuous_tags | default([]) }}"
        monitored_by: "{{ zbx_monitored_by | int }}"
        proxy_groupid: "{{ zbx_proxy_group_id | default('0') | int }}"
      auth: "{{ zabbix_auth }}"
      id: 2
  register: zbx_update_resp
  when:
    - zbx_scenario == 'update'
    - zbx_existing_host is defined
    - zbx_existing_host.hostid is defined
    - _interface_id is defined
    - _interface_id != ''
    - _zbx_interface_update is defined
    - _missing_params | default([]) | length == 0
    - _needs_update | default(true) | bool

- name: Record no update needed (already up-to-date)
  set_fact:
    device_result:
      hostname: "{{ zbx_record.HOSTNAME }}"
      status: "güncel"
      reason: "Değişiklik yok, güncelleme yapılmadı"
      ip: "{{ zbx_record.HOST_IP }}"
  when:
    - zbx_scenario == 'update'
    - zbx_existing_host.hostid is defined
    - _needs_update is defined
    - not (_needs_update | bool)

- name: Build updated fields list
  set_fact:
    _updated_fields: >-
      {%- set fields = [] -%}
      {%- if zbx_existing_host.host | default('') != zbx_record.HOSTNAME -%}
        {%- set _ = fields.append('Hostname: ' ~ zbx_existing_host.host | default('N/A') ~ ' → ' ~ zbx_record.HOSTNAME) -%}
      {%- endif -%}
      {%- if _existing_interface.ip | default('') != zbx_record.HOST_IP -%}
        {%- set _ = fields.append('IP: ' ~ _existing_interface.ip | default('N/A') ~ ' → ' ~ zbx_record.HOST_IP) -%}
      {%- endif -%}
      {%- if zbx_existing_host.monitored_by | default('') | string != zbx_monitored_by | string -%}
        {%- set _ = fields.append('Monitored By: ' ~ zbx_existing_host.monitored_by | default('N/A') ~ ' → ' ~ zbx_monitored_by) -%}
      {%- endif -%}
      {%- if zbx_existing_host.proxy_groupid | default('') | string != zbx_proxy_group_id | string -%}
        {%- set _ = fields.append('Proxy Group: ' ~ zbx_existing_host.proxy_groupid | default('N/A') ~ ' → ' ~ zbx_proxy_group_id) -%}
      {%- endif -%}
      {%- if (zbx_existing_host.tags | default([]) | to_json) != (zbx_continuous_tags | to_json) -%}
        {%- set _ = fields.append('Tags güncellendi') -%}
      {%- endif -%}
      {{ fields | join(', ') }}
  when:
    - zbx_scenario == 'update'
    - _needs_update is defined
    - _needs_update | bool
    - zbx_update_resp is defined
    - zbx_update_resp.json is defined
    - zbx_update_resp.json.result is defined
    - zbx_update_resp.json.error is not defined

- name: Record update success
  set_fact:
    device_result:
      hostname: "{{ zbx_record.HOSTNAME }}"
      status: "güncellendi"
      reason: "{{ _updated_fields | default('Bilinmeyen değişiklikler') }}"
      ip: "{{ zbx_record.HOST_IP }}"
  when:
    - zbx_scenario == 'update'
    - _needs_update is defined
    - _needs_update | bool
    - zbx_update_resp is defined
    - zbx_update_resp.json is defined
    - zbx_update_resp.json.result is defined
    - zbx_update_resp.json.error is not defined

- name: Record update failure
  set_fact:
    device_result:
      hostname: "{{ zbx_record.HOSTNAME }}"
      status: "eklenemedi"
      reason: "Güncelleme hatası: {{ zbx_update_resp.json.error.message | default(zbx_update_resp.json.error.data | default('Bilinmeyen hata')) }}"
      ip: "{{ zbx_record.HOST_IP }}"
  when:
    - zbx_scenario == 'update'
    - _needs_update is defined
    - _needs_update | bool
    - zbx_update_resp is defined
    - zbx_update_resp.json is defined
    - zbx_update_resp.json.error is defined
