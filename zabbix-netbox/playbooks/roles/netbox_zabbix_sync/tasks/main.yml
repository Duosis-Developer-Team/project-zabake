---
- name: Load template mappings
  set_fact:
    templates_map: "{{ lookup('file', templates_map_path) | from_yaml }}"
    datacenters_map: "{{ lookup('file', datacenters_map_path) | from_yaml }}"
    device_type_mapping: "{{ lookup('file', device_type_mapping_path) | from_yaml }}"

- name: Fetch all devices from Netbox API (with pagination and mapping-based filtering)
  include_tasks: fetch_all_devices.yml

- name: Fetch all hosts from Zabbix API (for mapping and update detection)
  include_tasks: fetch_all_zabbix_hosts.yml

- name: Set filtered devices (mapping-based filters already applied in Python script)
  set_fact:
    netbox_devices_filtered: "{{ netbox_devices_raw }}"

- name: Apply device limit
  set_fact:
    netbox_devices_final: >-
      {%- set limit = device_limit | int -%}
      {%- if limit > 0 -%}
      {{ netbox_devices_filtered[:limit] }}
      {%- else -%}
      {{ netbox_devices_filtered }}
      {%- endif -%}

- name: Initialize processing results list
  set_fact:
    processing_results: []

- name: Display device count
  debug:
    msg: "Found {{ netbox_devices_final | length }} devices to process (limit: {{ 'unlimited' if device_limit | int == 0 else device_limit | int }}{% if location_filter and location_filter != '' %}, location filter: {{ location_filter }}{% endif %})"

- name: Display list of matching devices
  debug:
    msg: |
      ============================================
      MATCHING DEVICES FROM NETBOX
      ============================================
      {% for device in netbox_devices_final %}
      Device #{{ loop.index }}:
        - Name: {{ device.name | default('N/A') }}
        - ID: {{ device.id | default('N/A') }}
        - Site: {{ device.site.name | default('N/A') if device.site else 'N/A' }}
        - Role: {% if device.role %}{{ device.role.name | default('N/A') }}{% elif device.device_role %}{{ device.device_role.name | default('N/A') }}{% else %}N/A{% endif %}
        - Manufacturer: {{ device.device_type.manufacturer.name | default('N/A') if device.device_type.manufacturer else 'N/A' }}
        - Model: {{ device.device_type.model | default('N/A') if device.device_type else 'N/A' }}
        - Primary IP: {{ device.primary_ip4.address | default('N/A') if device.primary_ip4 else 'N/A' }}
      {% endfor %}
      ============================================
  when: netbox_devices_final | length > 0

- name: Process each device
  include_tasks: process_device.yml
  loop: "{{ netbox_devices_final }}"
  loop_control:
    loop_var: outer_device_item
    label: "{{ outer_device_item.name | default('Unknown') }}"
  vars:
    netbox_device: "{{ outer_device_item }}"

- name: Collect all device results from temporary files
  find:
    paths: /tmp
    patterns: "zabbix_csv_import_result_*.json"
  register: result_files
  delegate_to: localhost
  run_once: true

- name: Load all device results
  set_fact:
    processing_results: >-
      {%- set results = [] -%}
      {%- for file in result_files.files | default([]) -%}
      {%- set file_content = lookup('file', file.path) | from_json -%}
      {%- if file_content -%}
      {%- set _ = results.append(file_content) -%}
      {%- endif -%}
      {%- endfor -%}
      {{ results }}
  delegate_to: localhost
  run_once: true
  when: result_files.files is defined and result_files.files | length > 0

- name: Set empty results if no files found
  set_fact:
    processing_results: []
  when: result_files.files is not defined or result_files.files | length == 0
  delegate_to: localhost
  run_once: true

- name: Clean up temporary result files
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ result_files.files | default([]) }}"
  delegate_to: localhost
  run_once: true
  when: result_files.files is defined

- name: Send notification email for failed devices
  include_tasks: send_notification_email.yml
  when: processing_results is defined and processing_results | length > 0
