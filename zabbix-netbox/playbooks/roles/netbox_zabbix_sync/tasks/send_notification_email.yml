---
- name: Calculate device statistics
  set_fact:
    has_failed_devices: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'eklenemedi') | list | length > 0 }}"
    failed_devices_count: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'eklenemedi') | list | length }}"
    added_devices_count: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list | length }}"
    updated_devices_count: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncellendi') | list | length }}"
    current_devices_count: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncel') | list | length }}"
    total_devices_count: "{{ processing_results | default([]) | length }}"

- name: Generate email HTML content
  set_fact:
    email_html_content: >-
      <html>
      <head>
        <style>
          body { font-family: Arial, sans-serif; }
          table { border-collapse: collapse; width: 100%; margin: 20px 0; }
          th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
          th { background-color: #4CAF50; color: white; }
          tr:nth-child(even) { background-color: #f2f2f2; }
          .status-eklendi { color: #4CAF50; font-weight: bold; }
          .status-guncellendi { color: #2196F3; font-weight: bold; }
          .status-eklenemedi { color: #f44336; font-weight: bold; }
          .summary { margin: 20px 0; padding: 15px; background-color: #f9f9f9; border-left: 4px solid #4CAF50; }
          .section-header { margin-top: 30px; padding: 10px; background-color: #e8f5e9; border-left: 4px solid #4CAF50; }
        </style>
      </head>
      <body>
        <h2>Zabbix Migration Ä°ÅŸlem Raporu</h2>
        <div class="summary">
          <h3>Ã–zet</h3>
          <p><strong>Toplam Ä°ÅŸlem:</strong> {{ processing_results | default([]) | length }}</p>
          <p><strong>BaÅŸarÄ±lÄ± (Eklendi):</strong> {{ processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list | length }}</p>
          <p><strong>GÃ¼ncellendi:</strong> {{ processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncellendi') | list | length }}</p>
          <p><strong>GÃ¼ncel (DeÄŸiÅŸiklik Yok):</strong> {{ processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncel') | list | length }}</p>
          <p><strong>BaÅŸarÄ±sÄ±z (Eklenemedi):</strong> {{ failed_devices_count }}</p>
        </div>
        
        {%- set added_devices = processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list -%}
        {%- if added_devices | length > 0 -%}
        <div class="section-header"><h3>âœ… Eklenen Cihazlar ({{ added_devices | length }})</h3></div>
        <table>
          <thead>
            <tr>
              <th>Sunucu AdÄ±</th>
              <th>IP Adresi</th>
              <th>Ä°ÅŸlem Durumu</th>
              <th>AÃ§Ä±klama</th>
            </tr>
          </thead>
          <tbody>
            {%- for result in added_devices -%}
            <tr>
              <td>{{ result.hostname | default('N/A') }}</td>
              <td>{{ result.ip | default('N/A') }}</td>
              <td class="status-eklendi">EKLENDÄ°</td>
              <td>{{ result.reason | default('BaÅŸarÄ±yla eklendi') }}</td>
            </tr>
            {%- endfor -%}
          </tbody>
        </table>
        {%- endif -%}
        
        {%- set updated_devices = processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncellendi') | list -%}
        {%- if updated_devices | length > 0 -%}
        <div class="section-header"><h3>ğŸ”„ GÃ¼ncellenen Cihazlar ({{ updated_devices | length }})</h3></div>
        <table>
          <thead>
            <tr>
              <th>Sunucu AdÄ±</th>
              <th>IP Adresi</th>
              <th>Ä°ÅŸlem Durumu</th>
              <th>GÃ¼ncellenen Alanlar</th>
            </tr>
          </thead>
          <tbody>
            {%- for result in updated_devices -%}
            <tr>
              <td>{{ result.hostname | default('N/A') }}</td>
              <td>{{ result.ip | default('N/A') }}</td>
              <td class="status-guncellendi">GÃœNCELLENDÄ°</td>
              <td>{{ result.reason | default('Bilinmeyen deÄŸiÅŸiklikler') }}</td>
            </tr>
            {%- endfor -%}
          </tbody>
        </table>
        {%- endif -%}
        
        {%- set failed_devices = processing_results | default([]) | selectattr('status', 'equalto', 'eklenemedi') | list -%}
        {%- if failed_devices | length > 0 -%}
        <div class="section-header" style="background-color: #ffebee; border-left-color: #f44336;"><h3>âŒ Eklenemeyen Cihazlar ({{ failed_devices | length }})</h3></div>
        <table>
          <thead>
            <tr>
              <th>Sunucu AdÄ±</th>
              <th>IP Adresi</th>
              <th>Ä°ÅŸlem Durumu</th>
              <th>Hata Sebebi</th>
            </tr>
          </thead>
          <tbody>
            {%- for result in failed_devices -%}
            <tr>
              <td>{{ result.hostname | default('N/A') }}</td>
              <td>{{ result.ip | default('N/A') }}</td>
              <td class="status-eklenemedi">EKLENEMEDI</td>
              <td>{{ result.reason | default('-') }}</td>
            </tr>
            {%- endfor -%}
          </tbody>
        </table>
        {%- endif -%}
        
        {%- set current_devices = processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncel') | list -%}
        {%- if current_devices | length > 0 -%}
        <div class="section-header" style="background-color: #e3f2fd; border-left-color: #2196F3;"><h3>â„¹ï¸ GÃ¼ncel Cihazlar (DeÄŸiÅŸiklik Yok) ({{ current_devices | length }})</h3></div>
        <table>
          <thead>
            <tr>
              <th>Sunucu AdÄ±</th>
              <th>IP Adresi</th>
              <th>Ä°ÅŸlem Durumu</th>
              <th>AÃ§Ä±klama</th>
            </tr>
          </thead>
          <tbody>
            {%- for result in current_devices -%}
            <tr>
              <td>{{ result.hostname | default('N/A') }}</td>
              <td>{{ result.ip | default('N/A') }}</td>
              <td style="color: #2196F3; font-weight: bold;">GÃœNCEL</td>
              <td>{{ result.reason | default('DeÄŸiÅŸiklik yok, gÃ¼ncelleme yapÄ±lmadÄ±') }}</td>
            </tr>
            {%- endfor -%}
          </tbody>
        </table>
        {%- endif -%}
        
        <p style="margin-top: 30px; color: #666; font-size: 12px;">
          Bu e-posta otomatik olarak Zabbix Migration playbook'u tarafÄ±ndan oluÅŸturulmuÅŸtur.
        </p>
      </body>
      </html>

- name: Generate email plain text content
  set_fact:
    email_text_content: >-
      ZABBIX MIGRATION Ä°ÅLEM RAPORU
      =============================
      
      Ã–ZET:
      -----
      Toplam Ä°ÅŸlem: {{ processing_results | default([]) | length }}
      BaÅŸarÄ±lÄ± (Eklendi): {{ processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list | length }}
      GÃ¼ncellendi: {{ processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncellendi') | list | length }}
      GÃ¼ncel (DeÄŸiÅŸiklik Yok): {{ processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncel') | list | length }}
      BaÅŸarÄ±sÄ±z (Eklenemedi): {{ failed_devices_count }}
      
      {%- set added_devices = processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list -%}
      {%- if added_devices | length > 0 %}
      
      âœ… EKLENEN CÄ°HAZLAR ({{ added_devices | length }}):
      ---------------------------------------
      {%- for result in added_devices %}
      
      Sunucu: {{ result.hostname | default('N/A') }}
      IP: {{ result.ip | default('N/A') }}
      Durum: EKLENDÄ°
      AÃ§Ä±klama: {{ result.reason | default('BaÅŸarÄ±yla eklendi') }}
      {%- endfor -%}
      {%- endif -%}
      
      {%- set updated_devices = processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncellendi') | list -%}
      {%- if updated_devices | length > 0 %}
      
      ğŸ”„ GÃœNCELLENEN CÄ°HAZLAR ({{ updated_devices | length }}):
      ------------------------------------------
      {%- for result in updated_devices %}
      
      Sunucu: {{ result.hostname | default('N/A') }}
      IP: {{ result.ip | default('N/A') }}
      Durum: GÃœNCELLENDÄ°
      GÃ¼ncellenen Alanlar: {{ result.reason | default('Bilinmeyen deÄŸiÅŸiklikler') }}
      {%- endfor -%}
      {%- endif -%}
      
      {%- set failed_devices = processing_results | default([]) | selectattr('status', 'equalto', 'eklenemedi') | list -%}
      {%- if failed_devices | length > 0 %}
      
      âŒ EKLENEMEYEN CÄ°HAZLAR ({{ failed_devices | length }}):
      ------------------------------------------
      {%- for result in failed_devices %}
      
      Sunucu: {{ result.hostname | default('N/A') }}
      IP: {{ result.ip | default('N/A') }}
      Durum: EKLENEMEDI
      Hata Sebebi: {{ result.reason | default('-') }}
      {%- endfor -%}
      {%- endif %}
      
      {%- set current_devices = processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncel') | list -%}
      {%- if current_devices | length > 0 %}
      
      â„¹ï¸ GÃœNCEL CÄ°HAZLAR (DEÄÄ°ÅÄ°KLÄ°K YOK) ({{ current_devices | length }}):
      -----------------------------------------
      {%- for result in current_devices %}
      
      Sunucu: {{ result.hostname | default('N/A') }}
      IP: {{ result.ip | default('N/A') }}
      Durum: GÃœNCEL
      AÃ§Ä±klama: {{ result.reason | default('DeÄŸiÅŸiklik yok, gÃ¼ncelleme yapÄ±lmadÄ±') }}
      {%- endfor -%}
      {%- endif %}
      
      ---
      Bu e-posta otomatik olarak Zabbix Migration playbook'u tarafÄ±ndan oluÅŸturulmuÅŸtur.

- name: Generate email subject
  set_fact:
    email_subject: >-
      {%- if has_failed_devices -%}
      Zabbix Migration Raporu - {{ failed_devices_count }} Sunucu Eklenemedi
      {%- else -%}
      Zabbix Migration Raporu - TÃ¼m Ä°ÅŸlemler BaÅŸarÄ±lÄ± ({{ added_devices_count }} Eklendi, {{ updated_devices_count }} GÃ¼ncellendi)
      {%- endif -%}

- name: Send notification email using Python SMTP
  shell: |
    python3 << 'PYTHON_SCRIPT'
    import smtplib
    from email.mime.text import MIMEText
    from email.mime.multipart import MIMEMultipart
    import sys
    
    # Email configuration
    smtp_host = "{{ mail_smtp_host }}"
    smtp_port = {{ mail_smtp_port }}
    smtp_user = "{{ mail_smtp_username | default('') }}"
    smtp_pass = "{{ mail_smtp_password | default('') }}"
    from_addr = "{{ mail_from }}"
    to_addrs = "{{ mail_recipients | join(',') }}"
    subject = "{{ email_subject }}"
    
    # Create message
    msg = MIMEMultipart('alternative')
    msg['Subject'] = subject
    msg['From'] = from_addr
    msg['To'] = to_addrs
    
    # Plain text version
    text_content = r"""{{ email_text_content }}"""
    
    # HTML version  
    html_content = r"""{{ email_html_content }}"""
    
    # Attach both versions
    part1 = MIMEText(text_content, 'plain', 'utf-8')
    part2 = MIMEText(html_content, 'html', 'utf-8')
    msg.attach(part1)
    msg.attach(part2)
    
    # Send email
    try:
        server = smtplib.SMTP(smtp_host, smtp_port, timeout=30)
        if smtp_user and smtp_pass:
            server.login(smtp_user, smtp_pass)
        server.sendmail(from_addr, [addr.strip() for addr in to_addrs.split(',')], msg.as_string())
        server.quit()
        print("âœ… Email sent successfully")
        sys.exit(0)
    except Exception as e:
        print(f"âš ï¸  Failed to send email: {e}")
        sys.exit(1)
    PYTHON_SCRIPT
  args:
    executable: /bin/bash
  when: 
    - processing_results is defined
    - processing_results | length > 0
    - mail_recipients is defined
    - mail_recipients | length > 0
  delegate_to: localhost
  run_once: true
  ignore_errors: true
  register: mail_send_result

- name: Display email notification status
  debug:
    msg: |
      ============================================
      EMAIL NOTIFICATION STATUS
      ============================================
      {% if processing_results is defined and processing_results | length > 0 %}
      ğŸ“Š Ä°ÅŸlem Ã–zeti:
      - Toplam: {{ total_devices_count }}
      - Eklendi: {{ added_devices_count }}
      - GÃ¼ncellendi: {{ updated_devices_count }}
      - GÃ¼ncel: {{ current_devices_count }}
      - BaÅŸarÄ±sÄ±z: {{ failed_devices_count }}
      {% if has_failed_devices %}
      âš ï¸  BaÅŸarÄ±sÄ±z iÅŸlem var: {{ failed_devices_count }} sunucu eklenemedi
      {% else %}
      âœ… TÃ¼m iÅŸlemler baÅŸarÄ±lÄ±
      {% endif %}
      {% if mail_recipients is defined and mail_recipients | length > 0 %}
      {% if mail_send_result is defined and mail_send_result.rc is defined %}
      {% if mail_send_result.rc == 0 %}
      âœ… E-posta baÅŸarÄ±yla gÃ¶nderildi: {{ mail_recipients | join(', ') }}
      YÃ¶ntem: Python SMTP
      {% else %}
      âš ï¸  E-posta gÃ¶nderilemedi
      Hata: {{ mail_send_result.stdout | default('Bilinmeyen hata') }}
      {% endif %}
      {% elif mail_send_result is skipped %}
      â„¹ï¸  E-posta gÃ¶nderimi atlandÄ±
      {% else %}
      â„¹ï¸  E-posta durumu: Belirsiz
      {% endif %}
      {% else %}
      â„¹ï¸  E-posta gÃ¶nderilmedi: mail_recipients tanÄ±mlÄ± deÄŸil
      {% endif %}
      {% else %}
      â„¹ï¸  Ä°ÅŸlem sonucu bulunamadÄ±
      {% endif %}
      ============================================
  run_once: true

