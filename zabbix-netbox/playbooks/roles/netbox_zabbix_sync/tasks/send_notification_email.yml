---
- name: Calculate device statistics
  set_fact:
    has_failed_devices: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'eklenemedi') | list | length > 0 }}"
    failed_devices_count: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'eklenemedi') | list | length }}"
    added_devices_count: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list | length }}"
    updated_devices_count: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncellendi') | list | length }}"
    current_devices_count: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncel') | list | length }}"
    total_devices_count: "{{ processing_results | default([]) | length }}"

- name: Generate email HTML content (Summary + Failures Only)
  set_fact:
    email_html_content: >-
      <html>
      <head>
        <style>
          body { font-family: Arial, sans-serif; }
          table { border-collapse: collapse; width: 100%; margin: 20px 0; }
          th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
          th { background-color: #f44336; color: white; }
          tr:nth-child(even) { background-color: #f2f2f2; }
          .status-eklenemedi { color: #f44336; font-weight: bold; }
          .summary { margin: 20px 0; padding: 15px; background-color: #f9f9f9; border-left: 4px solid #4CAF50; }
          .summary-warning { border-left-color: #f44336; }
          .section-header { margin-top: 30px; padding: 10px; background-color: #ffebee; border-left: 4px solid #f44336; }
          .info-box { padding: 10px; background-color: #e3f2fd; border-left: 4px solid #2196F3; margin: 20px 0; }
        </style>
      </head>
      <body>
        <h2>Loki - Zabbix Entegrasyonu Raporu</h2>
        <div class="summary {%- if failed_devices_count > 0 %} summary-warning{%- endif %}">
          <h3>ğŸ“Š Ã–zet</h3>
          <p><strong>Toplam Ä°ÅŸlem:</strong> {{ processing_results | default([]) | length }}</p>
          <p><strong>âœ… BaÅŸarÄ±lÄ± (Eklendi):</strong> {{ processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list | length }}</p>
          <p><strong>ğŸ”„ GÃ¼ncellendi:</strong> {{ processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncellendi') | list | length }}</p>
          <p><strong>â„¹ï¸ GÃ¼ncel (DeÄŸiÅŸiklik Yok):</strong> {{ processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncel') | list | length }}</p>
          <p><strong>âŒ BaÅŸarÄ±sÄ±z (Eklenemedi):</strong> {{ failed_devices_count }}</p>
        </div>
        
        {%- set failed_devices = processing_results | default([]) | selectattr('status', 'equalto', 'eklenemedi') | list -%}
        {%- if failed_devices | length > 0 -%}
        <div class="section-header"><h3>âŒ HATA: Eklenemeyen Cihazlar ({{ failed_devices | length }})</h3></div>
        <table>
          <thead>
            <tr>
              <th>Sunucu AdÄ±</th>
              <th>IP Adresi</th>
              <th>Ä°ÅŸlem Durumu</th>
              <th>Hata Sebebi</th>
            </tr>
          </thead>
          <tbody>
            {%- for result in failed_devices -%}
            <tr>
              <td>{{ result.hostname | default('N/A') }}</td>
              <td>{{ result.ip | default('N/A') }}</td>
              <td class="status-eklenemedi">EKLENEMEDI</td>
              <td>{{ result.reason | default('-') }}</td>
            </tr>
            {%- endfor -%}
          </tbody>
        </table>
        {%- else -%}
        <div class="info-box">
          <h3>âœ… TÃ¼m Cihazlar BaÅŸarÄ±yla Ä°ÅŸlendi</h3>
          <p>HiÃ§bir hata oluÅŸmadÄ±. TÃ¼m cihazlar baÅŸarÄ±yla eklendi veya gÃ¼ncellendi.</p>
        </div>
        {%- endif -%}
        
        <div class="info-box">
          <p><strong>ğŸ“ DetaylÄ± Rapor:</strong> TÃ¼m cihazlarÄ±n detaylÄ± bilgileri ekteki <code>zabbix_entegrasyon_detay.csv</code> dosyasÄ±nda yer almaktadÄ±r.</p>
        </div>
        
        <p style="margin-top: 30px; color: #999; font-size: 11px; opacity: 0.7;">
          Bu rapor otomatik olarak HMDL Automation tarafÄ±ndan oluÅŸturulmuÅŸtur.
        </p>
      </body>
      </html>

- name: Generate email plain text content (Summary + Failures Only)
  set_fact:
    email_text_content: >-
      LOKI - ZABBIX ENTEGRASYONU RAPORU
      ==================================
      
      Ã–ZET:
      -----
      Toplam Ä°ÅŸlem: {{ processing_results | default([]) | length }}
      âœ… BaÅŸarÄ±lÄ± (Eklendi): {{ processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list | length }}
      ğŸ”„ GÃ¼ncellendi: {{ processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncellendi') | list | length }}
      â„¹ï¸ GÃ¼ncel (DeÄŸiÅŸiklik Yok): {{ processing_results | default([]) | selectattr('status', 'equalto', 'gÃ¼ncel') | list | length }}
      âŒ BaÅŸarÄ±sÄ±z (Eklenemedi): {{ failed_devices_count }}
      
      {%- set failed_devices = processing_results | default([]) | selectattr('status', 'equalto', 'eklenemedi') | list -%}
      {%- if failed_devices | length > 0 %}
      
      âŒ HATA: EKLENEMEYEN CÄ°HAZLAR ({{ failed_devices | length }}):
      ------------------------------------------
      {%- for result in failed_devices %}
      
      Sunucu: {{ result.hostname | default('N/A') }}
      IP: {{ result.ip | default('N/A') }}
      Durum: EKLENEMEDI
      Hata Sebebi: {{ result.reason | default('-') }}
      {%- endfor -%}
      {%- else %}
      
      âœ… TÃœM CÄ°HAZLAR BAÅARIYLA Ä°ÅLENDÄ°
      ------------------------------------------
      HiÃ§bir hata oluÅŸmadÄ±. TÃ¼m cihazlar baÅŸarÄ±yla eklendi veya gÃ¼ncellendi.
      {%- endif %}
      
      
      ğŸ“ DETAYLI RAPOR:
      ------------------------------------------
      TÃ¼m cihazlarÄ±n detaylÄ± bilgileri ekteki "zabbix_entegrasyon_detay.csv" dosyasÄ±nda yer almaktadÄ±r.
      
      ---
      Bu rapor otomatik olarak HMDL Automation tarafÄ±ndan oluÅŸturulmuÅŸtur.

- name: Generate email subject
  set_fact:
    email_subject: >-
      {%- if has_failed_devices -%}
      Loki - Zabbix Entegrasyonu Raporu - {{ failed_devices_count }} Sunucu Eklenemedi
      {%- else -%}
      Loki - Zabbix Entegrasyonu Raporu - TÃ¼m Ä°ÅŸlemler BaÅŸarÄ±lÄ± ({{ added_devices_count }} Eklendi, {{ updated_devices_count }} GÃ¼ncellendi)
      {%- endif -%}

- name: Prepare email recipients as comma-separated string
  set_fact:
    mail_recipients_str: "{{ mail_recipients | join(',') }}"

- name: Convert processing results to JSON for Python
  set_fact:
    processing_results_json: "{{ processing_results | to_json }}"

- name: Send notification email with CSV attachment using Python SMTP
  shell: |
    python3 << 'PYTHON_SCRIPT'
    import smtplib
    from email.mime.text import MIMEText
    from email.mime.multipart import MIMEMultipart
    from email.mime.application import MIMEApplication
    import json
    import csv
    import io
    import sys
    from datetime import datetime
    
    # Email configuration
    smtp_host = "{{ mail_smtp_host }}"
    smtp_port = {{ mail_smtp_port }}
    smtp_user = "{{ mail_smtp_username | default('') }}"
    smtp_pass = "{{ mail_smtp_password | default('') }}"
    from_addr = "{{ mail_from }}"
    recipients_str = "{{ mail_recipients_str }}"
    subject = "{{ email_subject }}"
    
    # Processing results as JSON
    processing_results_json = r'''{{ processing_results_json }}'''
    
    # Parse recipients from comma-separated string
    to_addrs_list = [addr.strip() for addr in recipients_str.split(',') if addr.strip()]
    
    # Create comma-separated string for To header
    to_addrs_str = ', '.join(to_addrs_list)
    
    # Create main message container
    msg = MIMEMultipart('mixed')
    msg['Subject'] = subject
    msg['From'] = from_addr
    msg['To'] = to_addrs_str
    
    # Create alternative part for text/html
    msg_alternative = MIMEMultipart('alternative')
    msg.attach(msg_alternative)
    
    # Plain text version
    text_content = r"""{{ email_text_content }}"""
    
    # HTML version  
    html_content = r"""{{ email_html_content }}"""
    
    # Attach text and HTML versions
    part_text = MIMEText(text_content, 'plain', 'utf-8')
    part_html = MIMEText(html_content, 'html', 'utf-8')
    msg_alternative.attach(part_text)
    msg_alternative.attach(part_html)
    
    # Generate CSV attachment with all details
    try:
        processing_results = json.loads(processing_results_json)
        
        # Create CSV in memory
        csv_buffer = io.StringIO()
        csv_writer = csv.writer(csv_buffer, quoting=csv.QUOTE_ALL)
        
        # Write CSV header
        csv_writer.writerow([
            'SÄ±ra No',
            'Sunucu AdÄ±',
            'IP Adresi',
            'Ä°ÅŸlem Durumu',
            'AÃ§Ä±klama/Hata Sebebi',
            'Zaman DamgasÄ±'
        ])
        
        # Get current timestamp
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        
        # Sort results: failures first, then added, then updated, then current
        status_order = {'eklenemedi': 1, 'eklendi': 2, 'gÃ¼ncellendi': 3, 'gÃ¼ncel': 4}
        sorted_results = sorted(
            processing_results, 
            key=lambda x: status_order.get(x.get('status', '').lower(), 5)
        )
        
        # Write data rows
        for idx, result in enumerate(sorted_results, 1):
            hostname = result.get('hostname', 'N/A')
            ip_addr = result.get('ip', 'N/A')
            status = result.get('status', 'N/A').upper()
            reason = result.get('reason', '-')
            
            # Turkish status names
            status_tr = {
                'EKLENDI': 'EKLENDÄ°',
                'GÃœNCELLENDI': 'GÃœNCELLENDÄ°',
                'GÃœNCEL': 'GÃœNCEL',
                'EKLENEMEDI': 'EKLENEMEDI'
            }.get(status, status)
            
            csv_writer.writerow([idx, hostname, ip_addr, status_tr, reason, timestamp])
        
        # Create CSV attachment
        csv_content = csv_buffer.getvalue()
        csv_attachment = MIMEApplication(csv_content.encode('utf-8-sig'), _subtype='csv')
        csv_attachment.add_header(
            'Content-Disposition', 
            'attachment', 
            filename='zabbix_entegrasyon_detay.csv'
        )
        msg.attach(csv_attachment)
        
        print(f"INFO: CSV attachment created with {len(sorted_results)} records")
        
    except Exception as e:
        print(f"WARNING: Failed to create CSV attachment: {e}")
        print("INFO: Continuing without CSV attachment...")
    
    # Send email
    try:
        server = smtplib.SMTP(smtp_host, smtp_port, timeout=120)
        server.set_debuglevel(0)  # Set to 1 for debugging
        
        if smtp_user and smtp_pass:
            try:
                server.starttls()
            except:
                pass  # STARTTLS not supported, continue anyway
            server.login(smtp_user, smtp_pass)
        
        server.sendmail(from_addr, to_addrs_list, msg.as_string())
        server.quit()
        print("SUCCESS: Email sent successfully with CSV attachment")
        sys.exit(0)
    except smtplib.SMTPException as e:
        print(f"SMTP ERROR: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"ERROR: Failed to send email: {e}")
        sys.exit(1)
    PYTHON_SCRIPT
  args:
    executable: /bin/bash
  when: 
    - processing_results is defined
    - processing_results | length > 0
    - mail_recipients is defined
    - mail_recipients | length > 0
  delegate_to: localhost
  run_once: true
  ignore_errors: true
  register: mail_send_result

- name: Display email notification status
  debug:
    msg: |
      ============================================
      EMAIL NOTIFICATION STATUS
      ============================================
      {% if processing_results is defined and processing_results | length > 0 %}
      Ä°ÅLEM Ã–ZETÄ°:
      - Toplam: {{ total_devices_count }}
      - Eklendi: {{ added_devices_count }}
      - GÃ¼ncellendi: {{ updated_devices_count }}
      - GÃ¼ncel: {{ current_devices_count }}
      - BaÅŸarÄ±sÄ±z: {{ failed_devices_count }}
      {% if has_failed_devices %}
      UYARI: BaÅŸarÄ±sÄ±z iÅŸlem var - {{ failed_devices_count }} sunucu eklenemedi
      {% else %}
      BAÅARILI: TÃ¼m iÅŸlemler baÅŸarÄ±lÄ±
      {% endif %}
      {% if mail_recipients is defined and mail_recipients | length > 0 %}
      {% if mail_send_result is defined and mail_send_result.rc is defined %}
      {% if mail_send_result.rc == 0 %}
      BAÅARILI: E-posta baÅŸarÄ±yla gÃ¶nderildi: {{ mail_recipients | join(', ') }}
      YÃ¶ntem: Python SMTP
      {% else %}
      HATA: E-posta gÃ¶nderilemedi
      Hata: {{ mail_send_result.stdout | default('Bilinmeyen hata') }}
      {% endif %}
      {% elif mail_send_result is skipped %}
      BÄ°LGÄ°: E-posta gÃ¶nderimi atlandÄ±
      {% else %}
      BÄ°LGÄ°: E-posta durumu belirsiz
      {% endif %}
      {% else %}
      BÄ°LGÄ°: E-posta gÃ¶nderilmedi - mail_recipients tanÄ±mlÄ± deÄŸil
      {% endif %}
      {% else %}
      BÄ°LGÄ°: Ä°ÅŸlem sonucu bulunamadÄ±
      {% endif %}
      ============================================
  run_once: true

