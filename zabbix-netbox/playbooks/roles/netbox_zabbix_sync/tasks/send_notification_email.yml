---
- name: Calculate device statistics
  set_fact:
    has_failed_devices: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'eklenemedi') | list | length > 0 }}"
    failed_devices_count: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'eklenemedi') | list | length }}"
    added_devices_count: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list | length }}"
    updated_devices_count: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'güncellendi') | list | length }}"
    current_devices_count: "{{ processing_results | default([]) | selectattr('status', 'equalto', 'güncel') | list | length }}"
    total_devices_count: "{{ processing_results | default([]) | length }}"

- name: Generate email HTML content
  set_fact:
    email_html_content: >-
      <html>
      <head>
        <style>
          body { font-family: Arial, sans-serif; }
          table { border-collapse: collapse; width: 100%; margin: 20px 0; }
          th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
          th { background-color: #4CAF50; color: white; }
          tr:nth-child(even) { background-color: #f2f2f2; }
          .status-eklendi { color: #4CAF50; font-weight: bold; }
          .status-guncellendi { color: #2196F3; font-weight: bold; }
          .status-eklenemedi { color: #f44336; font-weight: bold; }
          .summary { margin: 20px 0; padding: 15px; background-color: #f9f9f9; border-left: 4px solid #4CAF50; }
          .section-header { margin-top: 30px; padding: 10px; background-color: #e8f5e9; border-left: 4px solid #4CAF50; }
        </style>
      </head>
      <body>
        <h2>Loki - Zabbix Entegrasyonu Raporu</h2>
        <div class="summary">
          <h3>Özet</h3>
          <p><strong>Toplam İşlem:</strong> {{ processing_results | default([]) | length }}</p>
          <p><strong>Başarılı (Eklendi):</strong> {{ processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list | length }}</p>
          <p><strong>Güncellendi:</strong> {{ processing_results | default([]) | selectattr('status', 'equalto', 'güncellendi') | list | length }}</p>
          <p><strong>Güncel (Değişiklik Yok):</strong> {{ processing_results | default([]) | selectattr('status', 'equalto', 'güncel') | list | length }}</p>
          <p><strong>Başarısız (Eklenemedi):</strong> {{ failed_devices_count }}</p>
        </div>
        
        {%- set added_devices = processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list -%}
        {%- if added_devices | length > 0 -%}
        <div class="section-header"><h3>BAŞARILI: Eklenen Cihazlar ({{ added_devices | length }})</h3></div>
        <table>
          <thead>
            <tr>
              <th>Sunucu Adı</th>
              <th>IP Adresi</th>
              <th>İşlem Durumu</th>
              <th>Açıklama</th>
            </tr>
          </thead>
          <tbody>
            {%- for result in added_devices -%}
            <tr>
              <td>{{ result.hostname | default('N/A') }}</td>
              <td>{{ result.ip | default('N/A') }}</td>
              <td class="status-eklendi">EKLENDİ</td>
              <td>{{ result.reason | default('Başarıyla eklendi') }}</td>
            </tr>
            {%- endfor -%}
          </tbody>
        </table>
        {%- endif -%}
        
        {%- set updated_devices = processing_results | default([]) | selectattr('status', 'equalto', 'güncellendi') | list -%}
        {%- if updated_devices | length > 0 -%}
        <div class="section-header"><h3>GÜNCELLEME: Güncellenen Cihazlar ({{ updated_devices | length }})</h3></div>
        <table>
          <thead>
            <tr>
              <th>Sunucu Adı</th>
              <th>IP Adresi</th>
              <th>İşlem Durumu</th>
              <th>Güncellenen Alanlar</th>
            </tr>
          </thead>
          <tbody>
            {%- for result in updated_devices -%}
            <tr>
              <td>{{ result.hostname | default('N/A') }}</td>
              <td>{{ result.ip | default('N/A') }}</td>
              <td class="status-guncellendi">GÜNCELLENDİ</td>
              <td>{{ result.reason | default('Bilinmeyen değişiklikler') }}</td>
            </tr>
            {%- endfor -%}
          </tbody>
        </table>
        {%- endif -%}
        
        {%- set failed_devices = processing_results | default([]) | selectattr('status', 'equalto', 'eklenemedi') | list -%}
        {%- if failed_devices | length > 0 -%}
        <div class="section-header" style="background-color: #ffebee; border-left-color: #f44336;"><h3>HATA: Eklenemeyen Cihazlar ({{ failed_devices | length }})</h3></div>
        <table>
          <thead>
            <tr>
              <th>Sunucu Adı</th>
              <th>IP Adresi</th>
              <th>İşlem Durumu</th>
              <th>Hata Sebebi</th>
            </tr>
          </thead>
          <tbody>
            {%- for result in failed_devices -%}
            <tr>
              <td>{{ result.hostname | default('N/A') }}</td>
              <td>{{ result.ip | default('N/A') }}</td>
              <td class="status-eklenemedi">EKLENEMEDI</td>
              <td>{{ result.reason | default('-') }}</td>
            </tr>
            {%- endfor -%}
          </tbody>
        </table>
        {%- endif -%}
        
        {%- set current_devices = processing_results | default([]) | selectattr('status', 'equalto', 'güncel') | list -%}
        {%- if current_devices | length > 0 -%}
        <div class="section-header" style="background-color: #e3f2fd; border-left-color: #2196F3;"><h3>BİLGİ: Güncel Cihazlar (Değişiklik Yok) ({{ current_devices | length }})</h3></div>
        <table>
          <thead>
            <tr>
              <th>Sunucu Adı</th>
              <th>IP Adresi</th>
              <th>İşlem Durumu</th>
              <th>Açıklama</th>
            </tr>
          </thead>
          <tbody>
            {%- for result in current_devices -%}
            <tr>
              <td>{{ result.hostname | default('N/A') }}</td>
              <td>{{ result.ip | default('N/A') }}</td>
              <td style="color: #2196F3; font-weight: bold;">GÜNCEL</td>
              <td>{{ result.reason | default('Değişiklik yok, güncelleme yapılmadı') }}</td>
            </tr>
            {%- endfor -%}
          </tbody>
        </table>
        {%- endif -%}
        
        <p style="margin-top: 30px; color: #999; font-size: 11px; opacity: 0.7;">
          Bu rapor otomatik olarak HMDL Automation tarafından oluşturulmuştur.
        </p>
      </body>
      </html>

- name: Generate email plain text content
  set_fact:
    email_text_content: >-
      LOKI - ZABBIX ENTEGRASYONU RAPORU
      ==================================
      
      ÖZET:
      -----
      Toplam İşlem: {{ processing_results | default([]) | length }}
      Başarılı (Eklendi): {{ processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list | length }}
      Güncellendi: {{ processing_results | default([]) | selectattr('status', 'equalto', 'güncellendi') | list | length }}
      Güncel (Değişiklik Yok): {{ processing_results | default([]) | selectattr('status', 'equalto', 'güncel') | list | length }}
      Başarısız (Eklenemedi): {{ failed_devices_count }}
      
      {%- set added_devices = processing_results | default([]) | selectattr('status', 'equalto', 'eklendi') | list -%}
      {%- if added_devices | length > 0 %}
      
      BAŞARILI: EKLENEN CİHAZLAR ({{ added_devices | length }}):
      ---------------------------------------
      {%- for result in added_devices %}
      
      Sunucu: {{ result.hostname | default('N/A') }}
      IP: {{ result.ip | default('N/A') }}
      Durum: EKLENDİ
      Açıklama: {{ result.reason | default('Başarıyla eklendi') }}
      {%- endfor -%}
      {%- endif -%}
      
      {%- set updated_devices = processing_results | default([]) | selectattr('status', 'equalto', 'güncellendi') | list -%}
      {%- if updated_devices | length > 0 %}
      
      GÜNCELLEME: GÜNCELLENEN CİHAZLAR ({{ updated_devices | length }}):
      ------------------------------------------
      {%- for result in updated_devices %}
      
      Sunucu: {{ result.hostname | default('N/A') }}
      IP: {{ result.ip | default('N/A') }}
      Durum: GÜNCELLENDİ
      Güncellenen Alanlar: {{ result.reason | default('Bilinmeyen değişiklikler') }}
      {%- endfor -%}
      {%- endif -%}
      
      {%- set failed_devices = processing_results | default([]) | selectattr('status', 'equalto', 'eklenemedi') | list -%}
      {%- if failed_devices | length > 0 %}
      
      HATA: EKLENEMEYEN CİHAZLAR ({{ failed_devices | length }}):
      ------------------------------------------
      {%- for result in failed_devices %}
      
      Sunucu: {{ result.hostname | default('N/A') }}
      IP: {{ result.ip | default('N/A') }}
      Durum: EKLENEMEDI
      Hata Sebebi: {{ result.reason | default('-') }}
      {%- endfor -%}
      {%- endif %}
      
      {%- set current_devices = processing_results | default([]) | selectattr('status', 'equalto', 'güncel') | list -%}
      {%- if current_devices | length > 0 %}
      
      BİLGİ: GÜNCEL CİHAZLAR (DEĞİŞİKLİK YOK) ({{ current_devices | length }}):
      -----------------------------------------
      {%- for result in current_devices %}
      
      Sunucu: {{ result.hostname | default('N/A') }}
      IP: {{ result.ip | default('N/A') }}
      Durum: GÜNCEL
      Açıklama: {{ result.reason | default('Değişiklik yok, güncelleme yapılmadı') }}
      {%- endfor -%}
      {%- endif %}
      
      ---
      Bu rapor otomatik olarak HMDL Automation tarafından oluşturulmuştur.

- name: Generate email subject
  set_fact:
    email_subject: >-
      {%- if has_failed_devices -%}
      Loki - Zabbix Entegrasyonu Raporu - {{ failed_devices_count }} Sunucu Eklenemedi
      {%- else -%}
      Loki - Zabbix Entegrasyonu Raporu - Tüm İşlemler Başarılı ({{ added_devices_count }} Eklendi, {{ updated_devices_count }} Güncellendi)
      {%- endif -%}

- name: Prepare email recipients as comma-separated string
  set_fact:
    mail_recipients_str: "{{ mail_recipients | join(',') }}"

- name: Send notification email using Python SMTP
  shell: |
    python3 << 'PYTHON_SCRIPT'
    import smtplib
    from email.mime.text import MIMEText
    from email.mime.multipart import MIMEMultipart
    import sys
    
    # Email configuration
    smtp_host = "{{ mail_smtp_host }}"
    smtp_port = {{ mail_smtp_port }}
    smtp_user = "{{ mail_smtp_username | default('') }}"
    smtp_pass = "{{ mail_smtp_password | default('') }}"
    from_addr = "{{ mail_from }}"
    recipients_str = "{{ mail_recipients_str }}"
    subject = "{{ email_subject }}"
    
    # Parse recipients from comma-separated string
    to_addrs_list = [addr.strip() for addr in recipients_str.split(',') if addr.strip()]
    
    # Create comma-separated string for To header
    to_addrs_str = ', '.join(to_addrs_list)
    
    # Create message
    msg = MIMEMultipart('alternative')
    msg['Subject'] = subject
    msg['From'] = from_addr
    msg['To'] = to_addrs_str
    
    # Plain text version
    text_content = r"""{{ email_text_content }}"""
    
    # HTML version  
    html_content = r"""{{ email_html_content }}"""
    
    # Attach both versions
    part1 = MIMEText(text_content, 'plain', 'utf-8')
    part2 = MIMEText(html_content, 'html', 'utf-8')
    msg.attach(part1)
    msg.attach(part2)
    
    # Send email
    try:
        server = smtplib.SMTP(smtp_host, smtp_port, timeout=30)
        if smtp_user and smtp_pass:
            server.login(smtp_user, smtp_pass)
        server.sendmail(from_addr, to_addrs_list, msg.as_string())
        server.quit()
        print("SUCCESS: Email sent successfully")
        sys.exit(0)
    except Exception as e:
        print(f"ERROR: Failed to send email: {e}")
        sys.exit(1)
    PYTHON_SCRIPT
  args:
    executable: /bin/bash
  when: 
    - processing_results is defined
    - processing_results | length > 0
    - mail_recipients is defined
    - mail_recipients | length > 0
  delegate_to: localhost
  run_once: true
  ignore_errors: true
  register: mail_send_result

- name: Display email notification status
  debug:
    msg: |
      ============================================
      EMAIL NOTIFICATION STATUS
      ============================================
      {% if processing_results is defined and processing_results | length > 0 %}
      İŞLEM ÖZETİ:
      - Toplam: {{ total_devices_count }}
      - Eklendi: {{ added_devices_count }}
      - Güncellendi: {{ updated_devices_count }}
      - Güncel: {{ current_devices_count }}
      - Başarısız: {{ failed_devices_count }}
      {% if has_failed_devices %}
      UYARI: Başarısız işlem var - {{ failed_devices_count }} sunucu eklenemedi
      {% else %}
      BAŞARILI: Tüm işlemler başarılı
      {% endif %}
      {% if mail_recipients is defined and mail_recipients | length > 0 %}
      {% if mail_send_result is defined and mail_send_result.rc is defined %}
      {% if mail_send_result.rc == 0 %}
      BAŞARILI: E-posta başarıyla gönderildi: {{ mail_recipients | join(', ') }}
      Yöntem: Python SMTP
      {% else %}
      HATA: E-posta gönderilemedi
      Hata: {{ mail_send_result.stdout | default('Bilinmeyen hata') }}
      {% endif %}
      {% elif mail_send_result is skipped %}
      BİLGİ: E-posta gönderimi atlandı
      {% else %}
      BİLGİ: E-posta durumu belirsiz
      {% endif %}
      {% else %}
      BİLGİ: E-posta gönderilmedi - mail_recipients tanımlı değil
      {% endif %}
      {% else %}
      BİLGİ: İşlem sonucu bulunamadı
      {% endif %}
      ============================================
  run_once: true

