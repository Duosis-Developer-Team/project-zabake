---
# Upload reports to remote storage (S3, NFS, SFTP)

- name: "Upload reports to S3"
  block:
    - name: "Install boto3 if needed"
      pip:
        name: boto3
        state: present
      when: ansible_python_version.major >= 3

    - name: "Upload reports to S3"
      shell: |
        python3 << 'PYTHON_SCRIPT'
        import boto3
        import os
        import glob
        from pathlib import Path
        
        s3_client = boto3.client(
            's3',
            aws_access_key_id='{{ report_storage.remote.s3_access_key }}',
            aws_secret_access_key='{{ report_storage.remote.s3_secret_key }}',
            region_name='{{ report_storage.remote.s3_region }}'
        )
        
        bucket = '{{ report_storage.remote.s3_bucket }}'
        prefix = '{{ report_storage.remote.s3_prefix }}'
        output_dir = '{{ output_dir }}'
        
        # Upload all report files
        pattern = os.path.join(output_dir, "zabbix_monitoring_*")
        for filepath in glob.glob(pattern):
            filename = os.path.basename(filepath)
            s3_key = prefix + filename
            
            try:
                s3_client.upload_file(filepath, bucket, s3_key)
                print(f"✅ Uploaded {filename} to s3://{bucket}/{s3_key}")
            except Exception as e:
                print(f"⚠️  Failed to upload {filename}: {e}")
                exit(1)
        
        print("✅ All reports uploaded to S3")
        PYTHON_SCRIPT
      when:
        - report_storage.remote.type == "s3"
        - report_storage.remote.s3_bucket != ""
      delegate_to: localhost
      run_once: true
      register: s3_upload_result

    - name: "Display S3 upload status"
      debug:
        msg: "{{ s3_upload_result.stdout_lines }}"
      when: s3_upload_result is defined

  when:
    - report_storage.remote.enabled | bool(false)
    - report_storage.remote.type == "s3"

- name: "Upload reports via SFTP"
  block:
    - name: "Copy reports to remote host via SFTP"
      synchronize:
        src: "{{ output_dir }}/zabbix_monitoring_*"
        dest: "{{ report_storage.remote.remote_path }}"
        mode: push
        private_key: "{{ report_storage.remote.remote_key | default(omit) }}"
      delegate_to: localhost
      when:
        - report_storage.remote.type == "sftp"
        - report_storage.remote.remote_host != ""

  when:
    - report_storage.remote.enabled | bool(false)
    - report_storage.remote.type == "sftp"

- name: "Upload reports to NFS mount"
  block:
    - name: "Mount NFS share"
      mount:
        path: "/mnt/nfs_reports"
        src: "{{ report_storage.remote.remote_host }}:{{ report_storage.remote.remote_path }}"
        fstype: nfs
        state: mounted
      when: report_storage.remote.type == "nfs"

    - name: "Copy reports to NFS"
      copy:
        src: "{{ item.path }}"
        dest: "/mnt/nfs_reports/{{ item.path | basename }}"
      loop: "{{ generated_reports.files }}"
      when: report_storage.remote.type == "nfs"

  when:
    - report_storage.remote.enabled | bool(false)
    - report_storage.remote.type == "nfs"
