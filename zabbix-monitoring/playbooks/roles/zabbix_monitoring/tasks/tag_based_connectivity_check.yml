---
# Tag-based connectivity check task

- name: "Create temporary output directory"
  tempfile:
    state: directory
    suffix: _zabbix_monitoring
  register: temp_output_dir
  changed_when: false

- name: "Build command arguments"
  set_fact:
    base_args:
      - "python3"
      - "{{ playbook_dir }}/../scripts/main.py"
      - "--mode"
      - "tag-based-connectivity"
      - "--zabbix-url"
      - "{{ zabbix_url }}"
      - "--zabbix-user"
      - "{{ zabbix_user }}"
      - "--zabbix-password"
      - "{{ zabbix_password }}"
      - "--output-dir"
      - "{{ temp_output_dir.path }}"
      - "--connection-tag"
      - "{{ connection_tag | default('connection status') }}"
      - "--history-limit"
      - "{{ history_limit | default(10) }}"
      - "--threshold-percentage"
      - "{{ threshold_percentage | default(70.0) }}"
      - "--log-level"
      - "ERROR"
      - "--log-file"
      - "{{ temp_output_dir.path }}/monitoring.log"

- name: "Add host-groups argument if specified"
  set_fact:
    final_args: "{{ base_args + ['--host-groups', host_groups] }}"
  when: host_groups is defined and host_groups | length > 0

- name: "Use base arguments if no host-groups"
  set_fact:
    final_args: "{{ base_args }}"
  when: host_groups is not defined or host_groups | length == 0

- name: "Run tag-based connectivity check"
  command:
    argv: "{{ final_args }}"
  register: tag_based_check_result
  changed_when: false
  failed_when: tag_based_check_result.rc != 0

- name: "Display tag-based check result"
  debug:
    msg: "{{ tag_based_check_result.stdout_lines }}"
  when: 
    - debug_enabled | default(false) | bool
    - tag_based_check_result.stdout_lines is defined

- name: "Check analysis results file"
  stat:
    path: "{{ temp_output_dir.path }}/tag_based_connectivity_analysis.json"
  register: analysis_results_file

- name: "Load analysis data for email"
  slurp:
    src: "{{ temp_output_dir.path }}/tag_based_connectivity_analysis.json"
  register: analysis_data
  when: analysis_results_file.stat.exists

- name: "Set analysis data as fact"
  set_fact:
    connectivity_analysis: "{{ analysis_data.content | b64decode | from_json }}"
  when: analysis_results_file.stat.exists

- name: "Clean up temporary directory"
  file:
    path: "{{ temp_output_dir.path }}"
    state: absent
  changed_when: false
  ignore_errors: true
