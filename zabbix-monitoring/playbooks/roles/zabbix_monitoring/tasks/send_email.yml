---
# Send email notification with reports

- name: "Load analysis results for email content"
  slurp:
    src: "{{ output_dir }}/zabbix_monitoring_*.json"
  register: report_json_data
  failed_when: false
  when: generated_reports.files | length > 0

- name: "Parse report data"
  set_fact:
    report_data: "{{ report_json_data.content | b64decode | from_json }}"
  when:
    - report_json_data is defined
    - report_json_data.content is defined

- name: "Calculate statistics for email"
  set_fact:
    email_stats:
      total_hosts: "{{ report_data.summary.total_hosts | default(0) }}"
      hosts_with_connectivity: "{{ report_data.summary.host_with_connectivity | default(0) }}"
      hosts_without_connectivity: "{{ report_data.summary.hosts_without_connectivity | default(0) }}"
      average_score: "{{ report_data.summary.average_connectivity_score | default(0.0) }}"
      total_items: "{{ report_data.summary.total_connectivity_items | default(0) }}"
      active_items: "{{ report_data.summary.active_items | default(0) }}"
      inactive_items: "{{ report_data.summary.inactive_items | default(0) }}"
  when: report_data is defined

- name: "Determine email subject"
  set_fact:
    email_subject: >-
      {%- if email_stats.hosts_without_connectivity | int(0) > 0 -%}
      Zabbix Monitoring - {{ email_stats.hosts_without_connectivity }} Host Connectivity Issues Detected
      {%- else -%}
      Zabbix Monitoring - All Hosts Healthy ({{ email_stats.total_hosts }} hosts checked)
      {%- endif -%}

- name: "Generate email HTML content"
  set_fact:
    email_html_content: >-
      <html>
      <head>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          .header { background-color: #4CAF50; color: white; padding: 20px; border-radius: 5px; }
          .summary { margin: 20px 0; padding: 15px; background-color: #f9f9f9; border-left: 4px solid #4CAF50; }
          .warning { border-left-color: #ff9800; background-color: #fff3e0; }
          .error { border-left-color: #f44336; background-color: #ffebee; }
          table { border-collapse: collapse; width: 100%; margin: 20px 0; }
          th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
          th { background-color: #4CAF50; color: white; }
          tr:nth-child(even) { background-color: #f2f2f2; }
          .score-good { color: #4CAF50; font-weight: bold; }
          .score-warning { color: #ff9800; font-weight: bold; }
          .score-error { color: #f44336; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>Zabbix Monitoring Connectivity Report</h1>
          <p>Generated: {{ ansible_date_time.iso8601 }}</p>
        </div>
        
        <div class="summary {% if email_stats.hosts_without_connectivity | int(0) > 0 %}error{% else %}warning{% endif %}">
          <h2>Summary</h2>
          <p><strong>Total Hosts:</strong> {{ email_stats.total_hosts }}</p>
          <p><strong>Hosts with Connectivity:</strong> {{ email_stats.hosts_with_connectivity }}</p>
          <p><strong>Hosts without Connectivity:</strong> {{ email_stats.hosts_without_connectivity }}</p>
          <p><strong>Average Connectivity Score:</strong> 
            <span class="{% if email_stats.average_score | float(0) >= 0.8 %}score-good{% elif email_stats.average_score | float(0) >= 0.5 %}score-warning{% else %}score-error{% endif %}">
              {{ "%.2f" | format(email_stats.average_score | float(0)) }}
            </span>
          </p>
          <p><strong>Total Items:</strong> {{ email_stats.total_items }}</p>
          <p><strong>Active Items:</strong> {{ email_stats.active_items }}</p>
          <p><strong>Inactive Items:</strong> {{ email_stats.inactive_items }}</p>
        </div>
        
        {% if email_stats.hosts_without_connectivity | int(0) > 0 %}
        <div class="summary error">
          <h3>⚠️ Connectivity Issues Detected</h3>
          <p>Some hosts are experiencing connectivity problems. Please review the attached report for details.</p>
        </div>
        {% else %}
        <div class="summary">
          <h3>✅ All Hosts Healthy</h3>
          <p>All monitored hosts are reporting good connectivity.</p>
        </div>
        {% endif %}
        
        <p style="margin-top: 30px; color: #666; font-size: 12px;">
          This email was automatically generated by Zabbix Monitoring Integration.
          Detailed reports are attached.
        </p>
      </body>
      </html>
  when: email_stats is defined

- name: "Generate email plain text content"
  set_fact:
    email_text_content: >-
      ZABBIX MONITORING CONNECTIVITY REPORT
      =====================================
      
      Generated: {{ ansible_date_time.iso8601 }}
      
      SUMMARY:
      --------
      Total Hosts: {{ email_stats.total_hosts }}
      Hosts with Connectivity: {{ email_stats.hosts_with_connectivity }}
      Hosts without Connectivity: {{ email_stats.hosts_without_connectivity }}
      Average Connectivity Score: {{ "%.2f" | format(email_stats.average_score | float(0)) }}
      Total Items: {{ email_stats.total_items }}
      Active Items: {{ email_stats.active_items }}
      Inactive Items: {{ email_stats.inactive_items }}
      
      {% if email_stats.hosts_without_connectivity | int(0) > 0 %}
      ⚠️  CONNECTIVITY ISSUES DETECTED
      Some hosts are experiencing connectivity problems. Please review the attached report for details.
      {% else %}
      ✅ ALL HOSTS HEALTHY
      All monitored hosts are reporting good connectivity.
      {% endif %}
      
      ---
      This email was automatically generated by Zabbix Monitoring Integration.
      Detailed reports are attached.
  when: email_stats is defined

- name: "Prepare email recipients"
  set_fact:
    mail_recipients_str: "{{ report_storage.email.recipients | join(',') }}"

- name: "Find report files to attach"
  find:
    paths: "{{ output_dir }}"
    patterns: "zabbix_monitoring_*.{{ item }}"
  register: report_files_to_attach
  loop: "{{ report_storage.email.formats_to_attach }}"
  when: report_storage.email.attach_reports | default(true) | bool

- name: "Send email notification using Python SMTP"
  shell: |
    python3 << 'PYTHON_SCRIPT'
    import smtplib
    from email.mime.text import MIMEText
    from email.mime.multipart import MIMEMultipart
    from email.mime.base import MIMEBase
    from email import encoders
    import os
    import sys
    import glob
    
    # Email configuration
    smtp_host = "{{ report_storage.email.smtp_host }}"
    smtp_port = {{ report_storage.email.smtp_port }}
    smtp_user = "{{ report_storage.email.smtp_username | default('') }}"
    smtp_pass = "{{ report_storage.email.smtp_password | default('') }}"
    from_addr = "{{ report_storage.email.from_address }}"
    recipients_str = "{{ mail_recipients_str }}"
    subject = "{{ email_subject }}"
    output_dir = "{{ output_dir }}"
    formats_to_attach = {{ report_storage.email.formats_to_attach | to_json }}
    
    # Parse recipients
    to_addrs_list = [addr.strip() for addr in recipients_str.split(',') if addr.strip()]
    
    # Create message
    msg = MIMEMultipart('alternative')
    msg['Subject'] = subject
    msg['From'] = from_addr
    msg['To'] = ', '.join(to_addrs_list)
    
    # Plain text version
    text_content = r"""{{ email_text_content }}"""
    html_content = r"""{{ email_html_content }}"""
    
    # Attach text and HTML
    part1 = MIMEText(text_content, 'plain', 'utf-8')
    part2 = MIMEText(html_content, 'html', 'utf-8')
    msg.attach(part1)
    msg.attach(part2)
    
    # Attach report files
    {% if report_storage.email.attach_reports | default(true) | bool %}
    for fmt in formats_to_attach:
        pattern = os.path.join(output_dir, f"zabbix_monitoring_*.{fmt}")
        for filepath in glob.glob(pattern):
            with open(filepath, 'rb') as f:
                part = MIMEBase('application', 'octet-stream')
                part.set_payload(f.read())
                encoders.encode_base64(part)
                part.add_header(
                    'Content-Disposition',
                    f'attachment; filename= {os.path.basename(filepath)}'
                )
                msg.attach(part)
    {% endif %}
    
    # Send email
    try:
        server = smtplib.SMTP(smtp_host, smtp_port, timeout=30)
        if smtp_user and smtp_pass:
            server.login(smtp_user, smtp_pass)
        server.sendmail(from_addr, to_addrs_list, msg.as_string())
        server.quit()
        print("✅ Email sent successfully to: " + ', '.join(to_addrs_list))
        sys.exit(0)
    except Exception as e:
        print(f"⚠️  Failed to send email: {e}")
        sys.exit(1)
    PYTHON_SCRIPT
  args:
    executable: /bin/bash
  when:
    - report_storage.email.enabled | default(false) | bool
    - report_storage.email.recipients is defined
    - report_storage.email.recipients | length > 0
  delegate_to: localhost
  run_once: true
  ignore_errors: true
  register: mail_send_result

- name: "Display email notification status"
  debug:
    msg: |
      ============================================
      EMAIL NOTIFICATION STATUS
      ============================================
      {% if mail_send_result is defined and mail_send_result.rc is defined %}
      {% if mail_send_result.rc == 0 %}
      ✅ Email sent successfully
      Recipients: {{ report_storage.email.recipients | join(', ') }}
      {% else %}
      ⚠️  Email sending failed
      Error: {{ mail_send_result.stdout | default('Unknown error') }}
      {% endif %}
      {% else %}
      ℹ️  Email notification skipped or not configured
      {% endif %}
      ============================================
  when: report_storage.email.enabled | default(false) | bool
