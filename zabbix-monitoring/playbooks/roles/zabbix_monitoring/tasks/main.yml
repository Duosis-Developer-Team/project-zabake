---
# Main task file for zabbix_monitoring role
# Each step is designed to be debuggable in AWX

- name: "Zabbix Monitoring Check - Main Tasks"
  block:
    - name: "Validate configuration"
      include_tasks: validate_config.yml
      when: step_collect_data | default(true) | bool

    - name: "Collect data from Zabbix"
      include_tasks: collect_data.yml
      when: step_collect_data | default(true) | bool
      vars:
        debug_step: "collect_data"

    - name: "Analyze templates and detect connectivity items"
      include_tasks: analyze_templates.yml
      when: step_analyze_templates | default(true) | bool
      vars:
        debug_step: "analyze_templates"

    - name: "Detect connectivity items"
      include_tasks: detect_connectivity.yml
      when: step_detect_connectivity | default(true) | bool
      vars:
        debug_step: "detect_connectivity"

    - name: "Analyze connectivity data"
      include_tasks: analyze_data.yml
      when: step_analyze_data | default(true) | bool
      vars:
        debug_step: "analyze_data"

    - name: "Check master items"
      include_tasks: check_master_items.yml
      when: step_check_master_items | default(true) | bool
      vars:
        debug_step: "check_master_items"

    - name: "Generate report"
      include_tasks: generate_report.yml
      when: step_generate_report | default(true) | bool
      vars:
        debug_step: "generate_report"

    - name: "Send email notification"
      include_tasks: send_notification_email.yml
      when: 
        - step_send_notifications | default(true) | bool
        - mail_recipients is defined
        - mail_recipients | length > 0
      vars:
        debug_step: "send_notification"

  rescue:
    - name: "Error occurred during monitoring check"
      debug:
        msg: "Error in step: {{ debug_step | default('unknown') }}"
      
    - name: "Create debug output directory if it doesn't exist"
      file:
        path: "{{ debug_output_dir }}"
        state: directory
        mode: '0755'
      when: debug_save_intermediate_files | default(true) | bool
    
    - name: "Save error information"
      copy:
        content: |
          Error occurred at: {{ ansible_date_time.iso8601 }}
          Step: {{ debug_step | default('unknown') }}
          Error: {{ ansible_failed_result.msg | default('Unknown error') }}
        dest: "{{ debug_output_dir }}/error_{{ ansible_date_time.epoch }}.txt"
        mode: '0644'
      when: debug_save_intermediate_files | default(true) | bool
      
    - name: "Fail the playbook"
      fail:
        msg: "Zabbix monitoring check failed at step: {{ debug_step | default('unknown') }}"
