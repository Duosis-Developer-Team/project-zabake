---
# Send email notification for tag-based connectivity analysis

- name: "Check if analysis data is available"
  set_fact:
    analysis: "{{ connectivity_analysis }}"
  when: connectivity_analysis is defined

- name: "Build email content for problematic items"
  set_fact:
    problematic_items_table: |
      {% set items = analysis.problematic_items | default([]) %}
      {% if items | length > 0 %}
      <h2>‚ö†Ô∏è Connection Problems Detected</h2>
      <p>The following items have connectivity scores below {{ analysis.summary.threshold_percentage }}%:</p>
      <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">
        <thead>
          <tr style="background-color: #f2f2f2;">
            <th>Host</th>
            <th>Host Status</th>
            <th>Item</th>
            <th>Score</th>
            <th>Item Status</th>
          </tr>
        </thead>
        <tbody>
        {% for item in items %}
          <tr style="background-color: {% if item.host_status == 'all_critical' %}#ffcccc{% elif item.host_status == 'partial' %}#ffe4b3{% else %}#ffffff{% endif %};">
            <td>{{ item.host_name | default(item.hostname) }}</td>
            <td style="text-align: center;">
              {% if item.host_status == 'all_critical' %}
              <span style="color: red; font-weight: bold;">ALL CRITICAL</span>
              {% elif item.host_status == 'partial' %}
              <span style="color: orange; font-weight: bold;">PARTIAL</span>
              {% else %}
              <span style="color: green;">ALL OK</span>
              {% endif %}
            </td>
            <td>{{ item.item_name }}</td>
            <td style="text-align: center;">
              {% if item.status == 'no_data' %}
              <span style="color: gray;">N/A</span>
              {% else %}
              {{ item.percentage }}%
              {% endif %}
            </td>
            <td style="text-align: center;">
              {% if item.status == 'critical' %}
              <span style="color: red; font-weight: bold;">CRITICAL</span>
              {% elif item.status == 'warning' %}
              <span style="color: orange; font-weight: bold;">WARNING</span>
              {% elif item.status == 'healthy' %}
              <span style="color: green;">HEALTHY</span>
              {% elif item.status == 'no_data' %}
              <span style="color: gray; font-weight: bold;">NO DATA</span>
              {% else %}
              <span style="color: gray;">{{ item.status | upper }}</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p style="color: green;">‚úÖ All connection items are healthy (above {{ analysis.summary.threshold_percentage }}% threshold).</p>
      {% endif %}
  when: connectivity_analysis is defined

- name: "Build email content for hosts without connection items"
  set_fact:
    hosts_without_items_section: |
      {% set hosts = analysis.hosts_without_connection_items | default([]) %}
      {% if hosts | length > 0 %}
      <h2>‚ÑπÔ∏è Hosts Without Connection Items</h2>
      <p>The following hosts do not have any items with 'connection status' tag:</p>
      <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">
        <thead>
          <tr style="background-color: #f2f2f2;">
            <th>Host ID</th>
            <th>Hostname</th>
            <th>Display Name</th>
          </tr>
        </thead>
        <tbody>
        {% for host in hosts %}
          <tr>
            <td>{{ host.hostid }}</td>
            <td>{{ host.hostname }}</td>
            <td>{{ host.host_name | default(host.hostname) }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% endif %}
  when: connectivity_analysis is defined

- name: "Build email summary"
  set_fact:
    email_summary: |
      <h2>üìä Summary</h2>
      <ul>
        <li><strong>Total Hosts Analyzed:</strong> {{ analysis.summary.total_hosts_analyzed }}</li>
        <li><strong>Hosts with Issues:</strong> {{ analysis.summary.hosts_with_issues }}</li>
        <li><strong>Hosts without Issues:</strong> {{ analysis.summary.hosts_without_issues }}</li>
        <li><strong>Hosts without Connection Items:</strong> {{ analysis.summary.hosts_without_connection_items }}</li>
        <li><strong>Total Items Analyzed:</strong> {{ analysis.summary.total_items_analyzed }}</li>
        <li><strong>Items Below Threshold:</strong> {{ analysis.summary.items_below_threshold }}</li>
        <li><strong>Threshold Percentage:</strong> {{ analysis.summary.threshold_percentage }}%</li>
        <li><strong>Analysis Timestamp:</strong> {{ analysis.summary.analysis_timestamp }}</li>
      </ul>
  when: connectivity_analysis is defined

- name: "Build complete email body"
  set_fact:
    email_body: |
      <html>
      <head>
        <style>
          body { font-family: Arial, sans-serif; }
          table { border-collapse: collapse; width: 100%; margin: 20px 0; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #4CAF50; color: white; }
        </style>
      </head>
      <body>
        <h1>üîç Zabbix Tag-Based Connectivity Report</h1>
        {{ email_summary }}
        {{ problematic_items_table }}
        {{ hosts_without_items_section }}
        <hr>
        <p style="color: gray; font-size: 12px;">
          This is an automated report generated by Zabbix Monitoring Integration.<br>
          Analysis Date: {{ analysis.summary.analysis_timestamp }}
        </p>
      </body>
      </html>
  when: connectivity_analysis is defined

- name: "Generate email subject"
  set_fact:
    email_subject: >-
      {%- if analysis.summary.hosts_with_issues > 0 -%}
      Zabbix Connectivity Report - {{ analysis.summary.hosts_with_issues }} Host(s) with Issues
      {%- else -%}
      Zabbix Connectivity Report - All Hosts Healthy
      {%- endif -%}
  when: connectivity_analysis is defined

- name: "Prepare email recipients"
  set_fact:
    mail_recipients_str: "{{ email_to if email_to is string else email_to | join(',') }}"
  when: connectivity_analysis is defined

- name: "Send notification email using Python SMTP"
  shell: |
    python3 << 'PYTHON_SCRIPT'
    import smtplib
    from email.mime.text import MIMEText
    from email.mime.multipart import MIMEMultipart
    import sys
    
    # Email configuration
    smtp_host = "{{ smtp_server }}"
    smtp_port = {{ smtp_port }}
    smtp_user = "{{ smtp_username | default('') }}"
    smtp_pass = "{{ smtp_password | default('') }}"
    from_addr = "{{ email_from }}"
    recipients_str = "{{ mail_recipients_str }}"
    subject = "{{ email_subject }}"
    
    # Parse recipients
    to_addrs_list = [addr.strip() for addr in recipients_str.split(',') if addr.strip()]
    to_addrs_str = ', '.join(to_addrs_list)
    
    # Create message
    msg = MIMEMultipart('alternative')
    msg['Subject'] = subject
    msg['From'] = from_addr
    msg['To'] = to_addrs_str
    
    # Plain text version (basic)
    text_content = """
    Zabbix Tag-Based Connectivity Report
    ====================================
    
    This is an HTML email. Please view it in an HTML-capable email client.
    
    Summary:
    - Total Hosts Analyzed: {{ analysis.summary.total_hosts_analyzed }}
    - Hosts with Issues: {{ analysis.summary.hosts_with_issues }}
    - Items Below Threshold: {{ analysis.summary.items_below_threshold }}
    
    Please view this email in HTML format for detailed information.
    """
    
    # HTML version
    html_content = r"""{{ email_body }}"""
    
    # Attach both versions
    part1 = MIMEText(text_content, 'plain', 'utf-8')
    part2 = MIMEText(html_content, 'html', 'utf-8')
    msg.attach(part1)
    msg.attach(part2)
    
    # Send email
    try:
        server = smtplib.SMTP(smtp_host, smtp_port, timeout=30)
        if smtp_user and smtp_pass:
            server.login(smtp_user, smtp_pass)
        server.sendmail(from_addr, to_addrs_list, msg.as_string())
        server.quit()
        print("‚úÖ Email sent successfully to: " + to_addrs_str)
        sys.exit(0)
    except Exception as e:
        print(f"‚ö†Ô∏è  Failed to send email: {e}")
        sys.exit(1)
    PYTHON_SCRIPT
  args:
    executable: /bin/bash
  when: 
    - connectivity_analysis is defined
    - send_email | default(true) | bool
    - email_to is defined
    - email_to | length > 0
  delegate_to: localhost
  run_once: true
  ignore_errors: true
  register: email_send_result

- name: "Display email notification status"
  debug:
    msg: |
      ============================================
      EMAIL NOTIFICATION STATUS
      ============================================
      {% if connectivity_analysis is defined %}
      üìä Analysis Summary:
      - Total Hosts: {{ analysis.summary.total_hosts_analyzed }}
      - Hosts with Issues: {{ analysis.summary.hosts_with_issues }}
      - Hosts without Issues: {{ analysis.summary.hosts_without_issues }}
      - Hosts without Connection Items: {{ analysis.summary.hosts_without_connection_items }}
      - Total Items Analyzed: {{ analysis.summary.total_items_analyzed }}
      - Items Below Threshold: {{ analysis.summary.items_below_threshold }}
      
      {% if email_send_result is defined and email_send_result.rc is defined %}
      {% if email_send_result.rc == 0 %}
      ‚úÖ Email sent successfully to: {{ email_to if email_to is string else email_to | join(', ') }}
      Method: Python SMTP
      {% else %}
      ‚ö†Ô∏è  Email sending failed
      Error: {{ email_send_result.stdout | default('Unknown error') }}
      {% endif %}
      {% elif email_send_result is skipped %}
      ‚ÑπÔ∏è  Email sending skipped
      {% else %}
      ‚ÑπÔ∏è  Email status: Undefined
      {% endif %}
      {% else %}
      ‚ÑπÔ∏è  Analysis results not found
      {% endif %}
      ============================================
  run_once: true
