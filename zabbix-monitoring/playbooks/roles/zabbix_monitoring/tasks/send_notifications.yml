---
# Send notifications and store reports

- name: "Send notifications and store reports"
  block:
    - name: "Check if reports were generated"
      find:
        paths: "{{ output_dir }}"
        patterns: "zabbix_monitoring_*"
      register: generated_reports
      failed_when: false

    - name: "Display report files"
      debug:
        msg: "Generated {{ generated_reports.files | length }} report file(s)"
      when: generated_reports.files | length > 0

    # Email Notification
    - name: "Send email notification"
      include_tasks: send_email.yml
      when:
        - report_storage.email.enabled | bool(false)
        - report_storage.email.recipients is defined
        - report_storage.email.recipients | length > 0
        - step_send_notifications | bool(true)

    # Remote Storage (S3, NFS, etc.)
    - name: "Upload reports to remote storage"
      include_tasks: upload_to_remote.yml
      when:
        - report_storage.remote.enabled | bool(false)
        - generated_reports.files | length > 0
        - step_send_notifications | bool(true)

    # Cleanup old reports (keep last N)
    - name: "Cleanup old reports"
      include_tasks: cleanup_reports.yml
      when:
        - report_storage.local.keep_last_n | int(0) > 0
        - generated_reports.files | length > 0

  rescue:
    - name: "Notification/Storage failed"
      debug:
        msg: "Failed to send notifications or store reports, but reports are available in {{ output_dir }}"
      failed_when: false
