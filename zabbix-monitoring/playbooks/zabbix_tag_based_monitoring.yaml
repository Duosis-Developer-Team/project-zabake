---
# Zabbix Tag-Based Connectivity Monitoring Playbook
# This playbook performs tag-based connectivity monitoring for Zabbix hosts
# 
# Required AWX Extra Variables:
#   - zabbix_url: Zabbix API URL
#   - zabbix_user: Zabbix username
#   - zabbix_password: Zabbix password (use AWX Credentials)
#   - smtp_server: SMTP server address
#   - email_to: Recipient email address(es)
#
# Optional AWX Extra Variables:
#   - connection_tag: Tag name (default: "connection status")
#   - history_limit: Number of values to analyze (default: 10)
#   - threshold_percentage: Minimum % (default: 70.0)
#   - host_groups: Filter by host groups (default: "" = all)
#   - smtp_port: SMTP port (default: 25)
#   - email_from: Sender email (default: zabbix-monitoring@example.com)

- name: "Zabbix Tag-Based Connectivity Monitoring"
  hosts: localhost
  gather_facts: yes
  
  # All variables should come from AWX Extra Variables or defaults/main.yml
  # No environment variable lookups - AWX manages variables
  
  tasks:
    - name: "Create debug output directory"
      file:
        path: "{{ debug_output_dir }}"
        state: directory
        mode: '0755'
    
    - name: "Validate required variables"
      assert:
        that:
          - zabbix_url is defined and zabbix_url | length > 0
          - zabbix_user is defined and zabbix_user | length > 0
          - zabbix_password is defined and zabbix_password | length > 0
        fail_msg: "Zabbix connection parameters (ZABBIX_URL, ZABBIX_USER, ZABBIX_PASSWORD) must be set"
    
    - name: "Run tag-based connectivity check"
      include_role:
        name: zabbix_monitoring
        tasks_from: tag_based_connectivity_check.yml
    
    - name: "Send email notification"
      include_role:
        name: zabbix_monitoring
        tasks_from: send_tag_based_notification_email.yml
      when: send_email | default(true) | bool
    
    - name: "Display completion message"
      debug:
        msg: |
          ========================================
          Tag-Based Connectivity Check Completed
          ========================================
          Results saved to: {{ debug_output_dir }}
          Log file: {{ log_file }}
