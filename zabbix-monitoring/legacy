---
# Zabbix Monitoring Check Playbook
# This playbook checks connectivity items and master items for Zabbix hosts
# Each step is debuggable in AWX
# Reports are sent via email only

- name: "Zabbix Monitoring Integration - Connectivity Check"
  hosts: localhost
  gather_facts: true
  become: false
  
  vars:
    # Zabbix connection settings (required)
    _zabbix_url: "{{ zabbix_url | default('') }}"
    _zabbix_user: "{{ zabbix_user | default('') }}"
    _zabbix_password: "{{ zabbix_password | default('') }}"
    
    # Email notification settings (optional)
    _mail_recipients: "{{ mail_recipients | default([]) }}"
  
  pre_tasks:
    - name: "Validate zabbix_url"
      fail:
        msg: "zabbix_url is required"
      when: _zabbix_url | length == 0
    
    - name: "Validate zabbix_user"
      fail:
        msg: "zabbix_user is required"
      when: _zabbix_user | length == 0
    
    - name: "Validate zabbix_password"
      fail:
        msg: "zabbix_password is required"
      when: _zabbix_password | length == 0
    
  roles:
    - role: zabbix_monitoring
      vars:
        zabbix_url: "{{ _zabbix_url }}"
        zabbix_user: "{{ _zabbix_user }}"
        zabbix_password: "{{ _zabbix_password }}"
        mail_recipients: "{{ _mail_recipients }}"

  post_tasks:
    - name: "Display final summary"
      debug:
        msg: |
          ============================================
          Zabbix Monitoring Check Completed
          ============================================
          Debug output directory: {{ debug_output_dir }}
          Log file: {{ log_file }}
          {% if _mail_recipients is defined and _mail_recipients | length > 0 %}
          Email sent to: {{ _mail_recipients | join(', ') }}
          {% else %}
          Email notification: Not configured
          {% endif %}
          ============================================
